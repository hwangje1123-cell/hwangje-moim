<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>황제모임 가계부 관리 시스템</title>
    <!-- 외부 라이브러리: Tailwind CSS, FontAwesome, SheetJS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithEmailAndPassword, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyABPfmRxiNzND5O8KdgP7QtHdQ0Mf74nMc",
            authDomain: "hwangje-moim.firebaseapp.com",
            projectId: "hwangje-moim",
            storageBucket: "hwangje-moim.firebasestorage.app",
            messagingSenderId: "358129736978",
            appId: "1:358129736978:web:45ea7c0db8fb61215b27cb"
        };

        const appId = "hwangje-moim-finance"; 
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 전역 상태 관리 ---
        const urlParams = new URLSearchParams(window.location.search);
        let currentMeetingId = urlParams.get('m') || localStorage.getItem('last_meeting_id') || '황제모임';
        let currentYear = urlParams.get('y') || new Date().getFullYear().toString();
        
        let appData = { years: [currentYear], financeBase: {}, members: [], ledger: {}, eventNames: {} };
        let isAdmin = false;
        let currentUser = null;
        let unsubscribeData = null;
        let unsubscribeList = null;
        let meetingList = [];

        const components = {
            meetingSelect: () => document.getElementById('meeting-select'),
            userInfo: () => document.getElementById('user-info'),
            loginBtn: () => document.getElementById('loginBtn'),
            titleYear: () => document.getElementById('title-year'),
            mainTitle: () => document.getElementById('main-title'),
            yearDropdown: () => document.getElementById('year-dropdown'),
            carryInput: () => document.getElementById('carry-over-input'),
            feeDisplay: () => document.getElementById('fee-total-display'),
            interestDisplay: () => document.getElementById('interest-total-display'),
            finalBalance: () => document.getElementById('final-balance'),
            ledgerBody: () => document.getElementById('ledger-body'),
            memberBody: () => document.getElementById('member-body'),
            settleHeader: () => document.getElementById('settle-header-row'),
            settleBody: () => document.getElementById('settle-body'),
            eventFilter: () => document.getElementById('event-filter'),
            modal: () => document.getElementById('custom-modal'),
            modalTitle: () => document.getElementById('modal-title'),
            modalBody: () => document.getElementById('modal-body'),
            modalConfirmBtn: () => document.getElementById('modal-confirm-btn'),
            toast: () => document.getElementById('toast-message')
        };

        // --- 유틸리티: 깜빡임 방지 업데이트 ---
        const updateHTML = (el, newHtml) => {
            if (el && el.innerHTML !== newHtml) {
                el.innerHTML = newHtml;
            }
        };

        window.showMessage = (msg) => {
            const toast = components.toast();
            if (!toast) return;
            toast.innerText = msg;
            toast.style.opacity = "1";
            setTimeout(() => toast.style.opacity = "0", 3000);
        };

        // --- 클라우드 통신부 ---
        window.saveToCloud = async () => {
            if (!isAdmin || !currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'meetings', currentMeetingId);
            try {
                await setDoc(docRef, appData);
            } catch (e) {
                console.error("Save Error:", e);
                window.showMessage("저장 권한이 없습니다.");
            }
        };

        window.createNewMeeting = async (name) => {
            if (!currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'meetings', name);
            const initialData = { 
                years: [new Date().getFullYear().toString()], 
                financeBase: {}, 
                members: [], 
                ledger: {}, 
                eventNames: {}, 
                isInactive: false 
            };
            try {
                await setDoc(docRef, initialData);
                window.showMessage(`${name} 모임이 생성되었습니다.`);
            } catch (e) { console.error("Create Moim Error:", e); }
        };

        window.ensureYearExists = (year) => {
            if (!Array.isArray(appData.years)) appData.years = [];
            if (!appData.years.includes(year)) {
                appData.years = [...appData.years, year];
                appData.years.sort((a, b) => Number(b) - Number(a));
            }
            if (!appData.ledger) appData.ledger = {};
            if (!appData.ledger[year]) appData.ledger[year] = [];
            if (!appData.financeBase) appData.financeBase = {};
            if (!appData.financeBase[year]) {
                appData.financeBase[year] = { carry: 0, monthlyFee: 10000, monthlyInterest: Array(12).fill(0) };
            }
        };

        // --- 모달 제어 (리스너 꼬임 해결) ---
        window.openModal = (title, bodyHtml, onConfirm) => {
            components.modalTitle().innerText = title;
            components.modalBody().innerHTML = bodyHtml;
            components.modal().classList.replace('hidden', 'flex');
            
            const confirmBtn = components.modalConfirmBtn();
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
            
            newBtn.onclick = async () => { 
                const res = await onConfirm();
                if (res !== false) window.closeModal(); 
            };
        };

        window.closeModal = () => {
            components.modal().classList.replace('flex', 'hidden');
        };

        // --- 인증 및 데이터 동기화 리스너 ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (e) { await signInAnonymously(auth); }
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Init Error", error);
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            isAdmin = !!user && !user.isAnonymous; 
            updateAuthUI();
            if (user) {
                syncMeetingList();
                startSync(currentMeetingId);
            }
        });

        function updateAuthUI() {
            const btn = components.loginBtn();
            const info = components.userInfo();
            if (!btn) return;
            if (isAdmin) {
                btn.innerText = "로그아웃";
                btn.classList.replace('bg-emerald-600', 'bg-slate-700');
                if (info) info.innerText = `관리자: ${currentUser.email}`;
                document.getElementById('title-container').classList.add('admin-mode');
            } else {
                btn.innerText = "관리자 로그인";
                btn.classList.replace('bg-slate-700', 'bg-emerald-600');
                if (info) info.innerText = currentUser ? "조회 전용 모드" : "인증 중...";
                document.getElementById('title-container').classList.remove('admin-mode');
            }
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = isAdmin ? 'flex' : 'none';
            });
        }

        const syncMeetingList = () => {
            const meetingsColl = collection(db, 'artifacts', appId, 'public', 'data', 'meetings');
            if (unsubscribeList) unsubscribeList();
            unsubscribeList = onSnapshot(meetingsColl, (snapshot) => {
                const newList = snapshot.docs.map(doc => doc.id).sort();
                const select = components.meetingSelect();
                if (JSON.stringify(meetingList) !== JSON.stringify(newList)) {
                    meetingList = newList;
                    if (meetingList.length === 0 && isAdmin) window.createNewMeeting('황제모임');
                    const optionsHtml = meetingList.map(m => `<option value="${m}" ${m === currentMeetingId ? 'selected' : ''}>${m}</option>`).join('');
                    updateHTML(select, optionsHtml);
                } else if (select && select.value !== currentMeetingId) {
                    select.value = currentMeetingId;
                }
            });
        };

        const startSync = (meetingId) => {
            if (unsubscribeData) unsubscribeData();
            currentMeetingId = meetingId;
            localStorage.setItem('last_meeting_id', meetingId);
            const titleEl = components.mainTitle();
            if (titleEl) titleEl.innerText = meetingId;
            const footerEl = document.getElementById('footer-meeting-name');
            if (footerEl) footerEl.innerText = meetingId;

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'meetings', meetingId);
            unsubscribeData = onSnapshot(docRef, (snapshot) => {
                if (snapshot.exists()) {
                    appData = snapshot.data();
                    if (!appData.years || appData.years.length === 0) appData.years = [currentYear];
                    if (!appData.years.includes(currentYear)) currentYear = appData.years[0];
                    renderAll();
                } else if (isAdmin) {
                    appData = { years: [currentYear], financeBase: {}, members: [], ledger: {}, eventNames: {} };
                    window.saveToCloud();
                }
            });
        };

        // --- 기능 함수 정의 ---
        window.renameMeeting = () => {
            if (!isAdmin) return;
            const bodyHtml = `<input type="text" id="rename-input" class="w-full p-4 border rounded-2xl text-black font-bold outline-none shadow-sm" value="${currentMeetingId}" onkeydown="if(event.key==='Enter') document.getElementById('modal-confirm-btn').click()">`;
            window.openModal("모임 이름 수정", bodyHtml, async () => {
                const newName = document.getElementById('rename-input').value.trim();
                if (!newName || newName === currentMeetingId) return true;
                if (meetingList.includes(newName)) return (window.showMessage("이미 있는 이름입니다."), false);
                try {
                    const oldRef = doc(db, 'artifacts', appId, 'public', 'data', 'meetings', currentMeetingId);
                    const newRef = doc(db, 'artifacts', appId, 'public', 'data', 'meetings', newName);
                    await setDoc(newRef, appData);
                    await deleteDoc(oldRef);
                    currentMeetingId = newName;
                    startSync(newName);
                    window.showMessage("이름이 변경되었습니다.");
                    return true;
                } catch (e) { return false; }
            });
            setTimeout(() => document.getElementById('rename-input')?.focus(), 200);
        };

        window.addNewMeeting = () => {
            if (!isAdmin) return;
            const bodyHtml = `<input type="text" id="new-moim-input" class="w-full p-4 border rounded-2xl text-black font-bold outline-none shadow-sm" placeholder="새 모임 이름" onkeydown="if(event.key==='Enter') document.getElementById('modal-confirm-btn').click()">`;
            window.openModal("새 모임 생성", bodyHtml, async () => {
                const name = document.getElementById('new-moim-input').value.trim();
                if (!name) return false;
                if (meetingList.includes(name)) return (window.showMessage("이미 있는 모임입니다."), false);
                await window.createNewMeeting(name);
                currentMeetingId = name;
                startSync(name);
                return true;
            });
            setTimeout(() => document.getElementById('new-moim-input')?.focus(), 200);
        };

        window.addNewYear = () => {
            if (!isAdmin) return;
            const bodyHtml = `<input type="number" id="new-year-input" class="w-full p-4 border rounded-2xl text-black font-bold text-center outline-none shadow-sm" placeholder="2026" onkeydown="if(event.key==='Enter') document.getElementById('modal-confirm-btn').click()">`;
            window.openModal("연도 추가", bodyHtml, async () => {
                const year = document.getElementById('new-year-input').value.trim();
                if (year.length !== 4) return (window.showMessage("4자리 연도를 입력하세요."), false);
                window.ensureYearExists(year);
                currentYear = year;
                await window.saveToCloud();
                renderAll();
                window.showMessage(`${year}년 데이터가 추가되었습니다.`);
                return true;
            });
            setTimeout(() => document.getElementById('new-year-input')?.focus(), 200);
        };

        window.addLedgerRow = () => {
            if (!isAdmin) return;
            if (!appData.ledger) appData.ledger = {};
            if (!appData.ledger[currentYear]) appData.ledger[currentYear] = [];
            appData.ledger[currentYear].push({ event: "", date: "", desc: "", type: "expense", amount: 0, note: "", image: "" });
            window.saveToCloud();
        };

        window.addMember = () => {
            if (!isAdmin) return;
            const n = document.getElementById('new-mem-name');
            const p = document.getElementById('new-mem-phone');
            if (!n || !n.value) return;
            if (!appData.members) appData.members = [];
            appData.members.push({ id: Date.now(), name: n.value, phone: p.value, memoByYear: {}, paidByYear: {}, isInactive: false });
            n.value = ''; p.value = '';
            window.saveToCloud();
        };

        window.onMeetingChange = (e) => startSync(e.target.value);
        window.changeYear = (v) => { currentYear = v; renderAll(); };

        // --- 렌더링 엔진 ---
        function renderAll() {
            renderHeader();
            renderLedger();
            renderIntegratedMemberSettle();
        }

        function renderHeader() {
            if (components.titleYear()) components.titleYear().innerText = `${currentYear}년`;
            const years = [...(appData.years || [])].sort((a,b)=>Number(b)-Number(a));
            const optHtml = years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
            updateHTML(components.yearDropdown(), optHtml);

            const base = (appData.financeBase && appData.financeBase[currentYear]) || { carry: 0, monthlyFee: 10000, monthlyInterest: Array(12).fill(0) };
            const carryInput = components.carryInput();
            if (document.activeElement !== carryInput) carryInput.value = base.carry || 0;
            
            const interestSum = (base.monthlyInterest || []).reduce((a, b) => a + b, 0);
            components.interestDisplay().innerText = interestSum.toLocaleString() + "원";
            let feeSum = 0;
            (appData.members || []).forEach(m => { if (m.paidByYear && m.paidByYear[currentYear]) feeSum += m.paidByYear[currentYear].filter(p => p).length * Number(base.monthlyFee); });
            components.feeDisplay().innerText = feeSum.toLocaleString() + "원";
            
            let ledBal = 0;
            if (appData.ledger && appData.ledger[currentYear]) {
                appData.ledger[currentYear].forEach(r => ledBal += (r.type === 'income' ? r.amount : -r.amount));
            }
            components.finalBalance().innerText = `${(Number(base.carry) + feeSum + interestSum + ledBal).toLocaleString()}원`;
        }

        function renderLedger() {
            const filterDropdown = components.eventFilter();
            if (!filterDropdown) return;
            const currentFilter = filterDropdown.value || 'all';
            const entries = (appData.ledger && appData.ledger[currentYear]) || [];
            const events = [...new Set(entries.map(e => e.event))].filter(e => e).sort();
            const filterHtml = '<option value="all">전체 내역 보기</option>' + events.map(ev => `<option value="${ev}" ${ev === currentFilter ? 'selected' : ''}>${ev}</option>`).join('');
            updateHTML(filterDropdown, filterHtml);

            let bodyHtml = '';
            let bal = Number((appData.financeBase[currentYear])?.carry || 0);
            let feeSum = 0;
            (appData.members || []).forEach(m => { if (m.paidByYear && m.paidByYear[currentYear]) feeSum += m.paidByYear[currentYear].filter(p => p).length * Number(appData.financeBase[currentYear]?.monthlyFee || 10000); });
            bal += feeSum + (appData.financeBase[currentYear]?.monthlyInterest || []).reduce((a,b)=>a+b, 0);

            [...entries].sort((a,b)=>(a.date||"").localeCompare(b.date||"")).forEach((r, idx) => {
                bal += (r.type === 'income' ? r.amount : -r.amount);
                if (currentFilter !== 'all' && r.event !== currentFilter) return;
                bodyHtml += `
                    <tr class="text-xs border-b bg-white transition-colors hover:bg-slate-50">
                        <td class="p-0 border-r-2 border-slate-200 sticky-col bg-inherit"><input value="${r.event}" class="w-full h-11 text-center font-bold outline-none bg-transparent" onchange="window.updateLedgerItem(${idx}, 'event', this.value)" ${!isAdmin?'disabled':''}></td>
                        <td class="p-0 border-r"><input value="${r.date}" class="w-full h-11 text-center font-mono outline-none bg-transparent" placeholder="YY.MM.DD" oninput="window.formatDateInput(this)" onchange="window.updateLedgerItem(${idx}, 'date', this.value)" ${!isAdmin?'disabled':''}></td>
                        <td class="p-0 border-r"><input value="${r.desc}" class="w-full h-11 px-4 text-left outline-none bg-transparent" onchange="window.updateLedgerItem(${idx}, 'desc', this.value)" ${!isAdmin?'disabled':''}></td>
                        <td class="p-0 border-r"><input type="number" value="${r.type==='income'?r.amount:''}" class="w-full h-11 px-3 text-right font-black outline-none bg-transparent" onchange="window.updateLedgerAmount(${idx}, 'income', this.value)" ${!isAdmin?'disabled':''}></td>
                        <td class="p-0 border-r"><input type="number" value="${r.type==='expense'?r.amount:''}" class="w-full h-11 px-3 text-right font-black outline-none bg-transparent" onchange="window.updateLedgerAmount(${idx}, 'expense', this.value)" ${!isAdmin?'disabled':''}></td>
                        <td class="p-3 text-right font-black bg-black/5 text-slate-800">${bal.toLocaleString()}</td>
                        <td class="p-3 border-r text-center">${r.image ? `<i class="fa-solid fa-image text-emerald-500 cursor-pointer" onclick="window.openImageViewer('${r.image}')"></i>` : '-'}</td>
                        <td class="p-0 border-r"><input value="${r.note || ''}" class="w-full h-11 px-3 text-center italic outline-none bg-transparent" onchange="window.updateLedgerItem(${idx}, 'note', this.value)" ${!isAdmin?'disabled':''}></td>
                        <td class="p-3 w-10 text-center">${isAdmin ? `<button onclick="window.deleteLedger(${idx})" class="text-slate-300 hover:text-red-500 transition-colors"><i class="fa-solid fa-trash-can"></i></button>` : ''}</td>
                    </tr>
                `;
            });
            updateHTML(components.ledgerBody(), bodyHtml);
        }

        function renderIntegratedMemberSettle() {
            const mBody = components.memberBody(); const sHead = components.settleHeader(); const sBody = components.settleBody();
            if(!mBody || !sHead || !sBody) return;
            appData.members.sort((a,b)=>a.name.localeCompare(b.name, 'ko'));
            
            const base = (appData.financeBase && appData.financeBase[currentYear]) || { monthlyFee: 10000, monthlyInterest: Array(12).fill(0) };
            const baseInput = document.getElementById('base-fee-input');
            if(baseInput) baseInput.value = base.monthlyFee || 10000;
            
            let mHtml = `<tr class="bg-emerald-50/50 text-[11px]"><td class="p-3 font-black sticky left-0 z-10 border-r-2 border-emerald-200 bg-emerald-50 text-center text-black">월별 이자(+)</td>`;
            for(let i=0; i<12; i++) { mHtml += `<td class="p-1 border-r border-emerald-100 text-center"><input type="number" value="${base.monthlyInterest ? base.monthlyInterest[i] : 0}" class="w-full text-center bg-transparent outline-none font-bold" onchange="window.updateInterest(${i}, this.value)" ${!isAdmin?'disabled':''}></td>`; }
            mHtml += `<td class="bg-emerald-50/20 border-l border-emerald-100"></td></tr>`;

            (appData.members || []).forEach(m => {
                const paid = (m.paidByYear && m.paidByYear[currentYear]) || Array(12).fill(false);
                mHtml += `<tr class="border-b text-xs bg-white ${m.isInactive?'opacity-40 grayscale line-through pointer-events-none':''}">`;
                mHtml += `<td class="p-2 sticky left-0 z-10 border-r-2 border-slate-200 bg-inherit min-w-[250px] whitespace-nowrap text-black font-bold"><div class="flex items-center gap-2"><span>${m.name}</span>${isAdmin ? `<button onclick="window.removeMember(${m.id})" class="text-slate-300 hover:text-red-500"><i class="fa-solid ${m.isInactive ? 'fa-rotate-left' : 'fa-trash-can'} text-[11px]"></i></button>` : ''}</div></td>`;
                paid.forEach((p, i) => { mHtml += `<td class="p-1 border-r text-center"><div onclick="window.toggleMemberPaid(${m.id}, ${i})" class="w-8 h-8 mx-auto flex items-center justify-center rounded-lg cursor-pointer ${p ? 'bg-emerald-600 text-white shadow-sm' : 'border border-slate-200 hover:border-emerald-300'}"><i class="fa-solid fa-check text-[10px]"></i></div></td>`; });
                mHtml += `<td class="p-1 border-r min-w-[150px]"><input value="${(m.memoByYear && m.memoByYear[currentYear]) || ''}" class="w-full h-8 px-2 outline-none font-medium bg-transparent text-black" onchange="window.updateMemberMemo(${m.id}, this.value)" ${!isAdmin?'disabled':''}></td></tr>`;
            });
            updateHTML(mBody, mHtml);

            const allYears = [...(appData.years || [])].sort((a,b)=>Number(a)-Number(b));
            let sHeadHtml = `<tr><th class="p-4 sticky left-0 z-20 bg-gray-100 border-r-2 border-slate-300 font-black text-black text-xs text-center">성명</th>` + allYears.map(y => `<th class="p-3 border-r font-black text-slate-500 text-[11px]">${y}년</th>`).join('') + `<th class="p-4 bg-emerald-700 text-white font-black text-xs">누적 합계</th></tr>`;
            updateHTML(sHead, sHeadHtml);

            let sBodyHtml = '';
            (appData.members || []).forEach(m => {
                let total = 0;
                sBodyHtml += `<tr class="border-b hover:bg-slate-50 transition-colors text-black text-center">`;
                sBodyHtml += `<td class="p-4 sticky left-0 z-10 font-bold border-r-2 bg-white text-black">${m.name}</td>`;
                allYears.forEach(y => {
                    const fee = (appData.financeBase && appData.financeBase[y] && appData.financeBase[y].monthlyFee) || 10000; 
                    const amt = (m.paidByYear && m.paidByYear[y] ? m.paidByYear[y].filter(p => p).length : 0) * fee; total += amt;
                    sBodyHtml += `<td class="p-3 border-r font-bold text-xs text-slate-700">${amt.toLocaleString()}</td>`;
                });
                sBodyHtml += `<td class="p-4 bg-emerald-50 font-black text-emerald-900 text-xs">${total.toLocaleString()}원</td></tr>`;
            });
            updateHTML(sBody, sBodyHtml);
        }

        // --- 기능 작동 함수 ---
        window.updateMonthlyFee = (v) => { if(!isAdmin) return; if(!appData.financeBase[currentYear]) appData.financeBase[currentYear] = {}; appData.financeBase[currentYear].monthlyFee = Number(v) || 0; window.saveToCloud(); };
        window.updateCarryOver = (v) => { if(!isAdmin) return; if(!appData.financeBase[currentYear]) appData.financeBase[currentYear] = {}; appData.financeBase[currentYear].carry = Number(v) || 0; window.saveToCloud(); };
        window.updateInterest = (idx, v) => { if(!isAdmin) return; if(!appData.financeBase[currentYear]) appData.financeBase[currentYear] = {}; if(!appData.financeBase[currentYear].monthlyInterest) appData.financeBase[currentYear].monthlyInterest = Array(12).fill(0); appData.financeBase[currentYear].monthlyInterest[idx] = Number(v) || 0; window.saveToCloud(); };
        window.updateMemberMemo = (id, v) => { if(!isAdmin) return; const m = appData.members.find(x => x.id === id); if(!m.memoByYear) m.memoByYear = {}; m.memoByYear[currentYear] = v; window.saveToCloud(); };
        window.toggleMemberPaid = (mid, idx) => { if(!isAdmin) return; const m = appData.members.find(x => x.id === mid); if(!m.paidByYear) m.paidByYear = {}; if(!m.paidByYear[currentYear]) m.paidByYear[currentYear] = Array(12).fill(false); m.paidByYear[currentYear][idx] = !m.paidByYear[currentYear][idx]; window.saveToCloud(); };
        window.removeMember = (id) => { if(!isAdmin) return; const m = appData.members.find(x => x.id === id); m.isInactive = !m.isInactive; window.saveToCloud(); };
        window.updateLedgerItem = (idx, f, v) => { if(!isAdmin) return; appData.ledger[currentYear][idx][f] = v; window.saveToCloud(); };
        window.updateLedgerAmount = (idx, t, v) => { if(!isAdmin) return; appData.ledger[currentYear][idx].type = t; appData.ledger[currentYear][idx].amount = Number(v) || 0; window.saveToCloud(); };
        window.deleteLedger = (idx) => { if(!isAdmin) return; appData.ledger[currentYear].splice(idx, 1); window.saveToCloud(); };
        window.formatDateInput = (el) => { el.value = el.value.replace(/[^0-9.]/g, ''); };
        window.switchView = (id) => { document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden')); document.getElementById(`view-${id}`)?.classList.remove('hidden'); document.querySelectorAll('nav button').forEach(b => b.classList.remove('active')); document.getElementById(`tab-${id}`)?.classList.add('active'); };
        window.openImageViewer = (src) => { components.viewerImg().src = src; document.getElementById('image-viewer').classList.replace('hidden', 'flex'); };
        
        window.handleAuth = async () => { 
            if (isAdmin) { 
                window.openModal("로그아웃", "로그아웃 하시겠습니까?", async () => { await signOut(auth); window.location.reload(); return true; }); 
            } else { 
                const bodyHtml = `<div class="space-y-4 text-black"><input type="email" id="login-email" class="w-full p-4 border rounded-2xl outline-none" placeholder="이메일" onkeydown="if(event.key==='Enter') document.getElementById('login-pw').focus()"><input type="password" id="login-pw" class="w-full p-4 border rounded-2xl outline-none" placeholder="비밀번호" onkeydown="if(event.key==='Enter') document.getElementById('modal-confirm-btn').click()"></div>`; 
                window.openModal("관리자 로그인", bodyHtml, async () => { 
                    const e = document.getElementById('login-email').value; 
                    const p = document.getElementById('login-pw').value; 
                    try { await signInWithEmailAndPassword(auth, e, p); window.showMessage("로그인 성공!"); return true; } 
                    catch (err) { window.showMessage("로그인 실패"); return false; } 
                }); 
                setTimeout(() => document.getElementById('login-email')?.focus(), 200);
            } 
        };
        
        initAuth();
        window.onload = () => { switchView('ledger'); };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; color: #334155; }
        .tab-btn { border-bottom: 4px solid transparent; transition: all 0.2s; font-weight: 700; color: #94a3b8; }
        .tab-btn.active { border-bottom-color: #059669; color: #065f46 !important; }
        input:focus { background-color: #f0fdf4 !important; border-bottom: 2px solid #10b981 !important; outline: none; }
        .sticky-col { position: sticky; left: 0; z-index: 10; border-right: 2px solid #e2e8f0 !important; }
        .admin-only { display: none; }
        #carry-over-input { color: white !important; transition: all 0.2s; }
        #carry-over-input:focus { color: black !important; background-color: white !important; }
        input::placeholder { color: #94a3b8 !important; }
        .admin-mode h1 { cursor: pointer; }
        .admin-mode h1:hover { color: #10b981; }
        .edit-icon { font-size: 0.5em; margin-left: 10px; color: #10b981; display: none; cursor: pointer; opacity: 0.6; }
        .admin-mode .edit-icon { display: inline-block; }
    </style>
</head>
<body class="min-h-screen text-black overflow-x-hidden">
    <div id="datalist-container"></div>
    <div id="toast-message" class="fixed top-5 left-1/2 -translate-x-1/2 z-[100] bg-slate-800 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl opacity-0 transition-opacity duration-300 pointer-events-none text-center"></div>

    <div id="image-viewer" class="fixed inset-0 bg-black/90 z-[110] hidden items-center justify-center p-4 cursor-pointer" onclick="this.classList.replace('flex','hidden')">
        <img id="viewer-img" src="" class="max-w-full max-h-full rounded-lg shadow-2xl object-contain">
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-black/60 z-[90] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl animate-in fade-in zoom-in duration-300 text-black">
            <div class="p-6 text-black text-center"><h3 id="modal-title" class="text-lg font-black mb-4 border-b pb-2 text-black">알림</h3><div id="modal-body" class="text-black"></div></div>
            <div class="flex border-t"><button onclick="window.closeModal()" class="flex-1 py-4 text-sm font-bold text-slate-400 hover:bg-slate-50 transition-colors">취소</button><button id="modal-confirm-btn" class="flex-1 py-4 text-sm font-black text-emerald-600 border-l hover:bg-emerald-50 transition-colors">확인</button></div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto bg-white shadow-2xl min-h-screen flex flex-col border-x border-gray-200">
        <!-- 상단 바 -->
        <div class="bg-slate-900 text-white text-[11px] p-2.5 px-5 flex flex-wrap gap-y-2 justify-between items-center shadow-md">
            <div class="flex items-center flex-wrap gap-3">
                <div class="flex items-center bg-white rounded-full pr-1 w-[220px] shrink-0 shadow-sm overflow-hidden text-black">
                    <div class="flex items-center gap-1.5 px-3 py-1.5 w-full text-black"><i class="fa-solid fa-users text-emerald-600"></i><span class="font-black text-slate-400 shrink-0">모임</span><select id="meeting-select" onchange="window.onMeetingChange(event)" class="bg-transparent text-black font-black outline-none cursor-pointer w-full truncate"></select></div>
                    <button onclick="window.addNewMeeting()" class="bg-emerald-600 w-7 h-7 shrink-0 rounded-full flex items-center justify-center admin-only hover:bg-emerald-500 transition-colors shadow"><i class="fa-solid fa-plus text-[10px]"></i></button>
                </div>
                <div class="flex items-center bg-white rounded-full pr-1 w-[160px] shrink-0 shadow-sm overflow-hidden text-black">
                    <div class="flex items-center gap-1.5 px-3 py-1.5 w-full text-black"><i class="fa-solid fa-calendar-days text-emerald-600"></i><span class="font-black text-slate-400 shrink-0">연도</span><select id="year-dropdown" onchange="window.changeYear(this.value)" class="bg-transparent text-black font-black outline-none cursor-pointer w-full"></select></div>
                    <button onclick="window.addNewYear()" class="bg-emerald-600 w-7 h-7 shrink-0 rounded-full flex items-center justify-center admin-only hover:bg-emerald-500 transition-colors shadow"><i class="fa-solid fa-plus text-[10px]"></i></button>
                </div>
                <button onclick="window.copyShareLink()" class="bg-slate-700 text-white px-4 py-1.5 rounded-full flex items-center gap-2 shrink-0 shadow-md hover:bg-slate-600 active:scale-95 transition-all"><i class="fa-solid fa-share-nodes text-[10px]"></i><span class="font-black text-[10px]">링크공유</span></button>
            </div>
            <div class="flex gap-2 shrink-0">
                <button id="loginBtn" onclick="window.handleAuth()" class="bg-emerald-600 px-3 py-1.5 rounded-lg font-black min-w-[100px] shadow-lg transition-all active:scale-95 hover:bg-emerald-500">관리자 로그인</button>
            </div>
        </div>

        <header class="bg-gradient-to-br from-emerald-900 to-slate-900 text-white p-8 relative overflow-hidden">
            <div id="title-container" class="flex justify-between items-end mb-8 relative z-10">
                <div class="flex items-center text-white">
                    <h1 id="main-title" onclick="window.renameMeeting()" class="text-3xl font-black tracking-tighter transition-colors">황제모임</h1>
                    <i class="fa-solid fa-pen-to-square edit-icon" onclick="window.renameMeeting()"></i>
                    <span id="title-year" class="text-emerald-500 font-medium text-lg ml-3 text-emerald-400"></span>
                </div>
                <div id="user-info" class="text-[10px] font-black uppercase text-slate-500 text-right tracking-widest text-white/50"></div>
            </div>
            <div class="grid grid-cols-3 gap-4 relative z-10 mb-4 text-center">
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10 backdrop-blur-md">
                    <p class="text-[10px] text-emerald-400 font-black mb-1 opacity-80 uppercase tracking-widest text-emerald-400">이월액</p>
                    <input type="number" id="carry-over-input" onchange="window.updateCarryOver(this.value)" onkeydown="if(event.key==='Enter') this.blur()" class="bg-transparent text-lg font-black w-full outline-none text-center rounded-lg transition-all text-white" placeholder="0">
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10 backdrop-blur-md"><p class="text-[10px] text-emerald-400 font-black mb-1 opacity-80 uppercase tracking-widest text-emerald-400">회비 합계</p><h3 id="fee-total-display" class="text-lg font-black text-white">0원</h3></div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10 backdrop-blur-md"><p class="text-[10px] text-emerald-400 font-black mb-1 opacity-80 uppercase tracking-widest text-emerald-400">이자 합계</p><h3 id="interest-total-display" class="text-lg font-black text-white">0원</h3></div>
            </div>
            <div class="bg-emerald-500 p-5 rounded-2xl shadow-2xl border border-emerald-400/30 relative z-10 text-white"><div class="flex justify-between items-center text-white text-white font-black uppercase tracking-widest"><p class="text-[11px] text-emerald-950 font-black italic uppercase tracking-widest">현재 총 잔액</p><h3 id="final-balance" class="text-3xl font-black text-white tracking-tighter">0원</h3></div></div>
        </header>

        <nav class="flex items-center border-b sticky top-0 bg-white/90 backdrop-blur-lg z-20 shadow-sm text-black">
            <button id="tab-ledger" onclick="window.switchView('ledger')" class="tab-btn flex-1 py-5 text-sm active">장부 기록</button>
            <button id="tab-member" onclick="window.switchView('member')" class="tab-btn flex-1 py-5 text-sm">명부 및 정산</button>
        </nav>

        <main class="p-6 flex-1 bg-slate-50/30 text-black">
            <div id="view-ledger" class="space-y-4">
                <div class="flex items-center justify-between">
                    <select id="event-filter" onchange="window.renderLedger()" class="bg-white border border-slate-200 rounded-full px-4 py-2 text-xs font-bold text-black min-w-[120px] shadow-sm outline-none cursor-pointer text-black"></select>
                    <div id="filter-summary"></div>
                </div>
                <div class="overflow-x-auto rounded-3xl border border-slate-200 bg-white shadow-xl">
                    <table class="w-full text-center border-collapse">
                        <thead class="bg-slate-50 text-slate-400 text-[10px] font-black uppercase border-b border-slate-200">
                            <tr><th class="p-4 sticky-col bg-slate-50 border-r-2 border-slate-200 text-slate-500">행사명</th><th class="p-4 border-r border-slate-100 text-slate-500">날짜</th><th class="p-4 border-r border-slate-100 text-slate-500">상세내역</th><th class="p-4 border-r border-slate-100 text-slate-500">입금</th><th class="p-4 border-r border-slate-100 text-slate-500">지출</th><th class="p-4 bg-black/5 border-r border-slate-200 text-black font-black text-slate-900">잔액</th><th class="p-4 border-r border-slate-100 text-slate-500">영수증</th><th class="p-4 border-r border-slate-100 text-slate-500">비고</th><th class="p-4 admin-only"></th></tr>
                        </thead>
                        <tbody id="ledger-body"></tbody>
                    </table>
                </div>
                <button onclick="window.addLedgerRow()" class="w-full py-6 border-2 border-dashed border-slate-200 text-slate-400 font-black rounded-3xl hover:bg-white admin-only flex-only items-center justify-center group shadow-sm"><i class="fa-solid fa-circle-plus mr-2 text-lg group-hover:scale-110 transition-transform"></i>거래 내역 추가</button>
            </div>
            
            <div id="view-member" class="hidden space-y-10">
                <section class="space-y-4">
                    <div class="flex items-center justify-between text-black">
                        <h2 class="text-xl font-black text-slate-800 tracking-tight text-black">회원 명부 및 월납 현황</h2>
                        <div class="admin-only flex gap-2 items-center text-black">
                            <input type="number" id="base-fee-input" class="w-20 p-2 text-sm font-bold border border-slate-200 rounded-xl text-black" onchange="window.updateMonthlyFee(this.value)">
                            <input type="text" id="new-mem-name" placeholder="이름" class="w-24 p-2.5 border border-slate-200 rounded-xl text-sm font-bold text-black">
                            <input type="text" id="new-mem-phone" placeholder="전화번호" class="w-32 p-2.5 border border-slate-200 rounded-xl text-sm font-bold text-black" onkeydown="if(event.key==='Enter') window.addMember()">
                            <button onclick="window.addMember()" class="bg-slate-900 text-white px-6 rounded-xl text-sm font-black hover:bg-emerald-700 active:scale-95 transition-all shadow">등록</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto rounded-3xl border border-slate-200 bg-white shadow-2xl">
                        <table class="w-full text-center border-collapse text-black">
                            <thead class="bg-slate-100 text-[10px] text-slate-500 font-black border-b border-slate-200 text-black">
                                <tr><th class="p-4 sticky left-0 z-20 bg-slate-100 border-r-2 border-slate-200 min-w-[250px] text-black font-black">회원 정보</th><th class="p-2 border-r border-slate-100 text-black">1</th><th class="p-2 border-r border-slate-100 text-black">2</th><th class="p-2 border-r border-slate-100 text-black">3</th><th class="p-2 border-r border-slate-100 text-black">4</th><th class="p-2 border-r border-slate-100 text-black">5</th><th class="p-2 border-r border-slate-100 text-black">6</th><th class="p-2 border-r border-slate-100 text-black">7</th><th class="p-2 border-r border-slate-100 text-black">8</th><th class="p-2 border-r border-slate-100 text-black">9</th><th class="p-2 border-r border-slate-100 text-black">10</th><th class="p-2 border-r border-slate-100 text-black">11</th><th class="p-2 border-r border-slate-100 text-black">12</th><th class="p-4 min-w-[150px] text-black border-l border-slate-200 font-black">비고</th></tr>
                            </thead>
                            <tbody id="member-body"></tbody>
                        </table>
                    </div>
                </section>
                <section class="space-y-4">
                    <h2 class="text-xl font-black text-slate-800 tracking-tight text-black text-black">년도별 회비 정산 요약</h2>
                    <div class="overflow-x-auto rounded-3xl border border-slate-200 bg-white shadow-2xl text-slate-900">
                        <table class="w-full text-center border-collapse text-black text-black">
                            <thead id="settle-header-row" class="bg-slate-100 font-black text-slate-500 border-b-2 border-slate-200 text-black text-xs"></thead>
                            <tbody id="settle-body" class="text-black"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
        <footer class="p-8 text-center text-[10px] text-slate-500 border-t bg-slate-50 font-bold uppercase tracking-widest text-black">&copy; 2026 <span id="footer-meeting-name"></span> 황제모임 재정 관리 시스템.</footer>
    </div>
</body>
</html>