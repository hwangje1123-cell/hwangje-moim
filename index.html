<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>황제모임 가계부 관리 시스템</title>
    <!-- 외부 라이브러리 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithEmailAndPassword, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyABPfmRxiNzND5O8KdgP7QtHdQ0Mf74nMc",
            authDomain: "hwangje-moim.firebaseapp.com",
            projectId: "hwangje-moim",
            storageBucket: "hwangje-moim.firebasestorage.app",
            messagingSenderId: "358129736978",
            appId: "1:358129736978:web:45ea7c0db8fb61215b27cb"
        };

        const appId = "hwangje-moim-finance"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 상태 관리
        const urlParams = new URLSearchParams(window.location.search);
        let currentMeetingId = urlParams.get('m') || localStorage.getItem('last_meeting_id') || '기본모임';
        let currentYear = urlParams.get('y'); 
        
        let appData = { years: [], financeBase: {}, members: [], ledger: {}, eventNames: {} };
        let isAdmin = false;
        let currentUser = null;
        let unsubscribeData = null;
        let unsubscribeList = null;
        let meetingList = [];
        let focusTargetId = null;

        const components = {
            meetingSelect: () => document.getElementById('meeting-select'),
            userInfo: () => document.getElementById('user-info'),
            loginBtn: () => document.getElementById('loginBtn'),
            titleYear: () => document.getElementById('title-year'),
            mainTitle: () => document.getElementById('main-title'),
            titleContainer: () => document.getElementById('title-container'),
            yearDropdown: () => document.getElementById('year-dropdown'),
            carryInput: () => document.getElementById('carry-over-input'),
            feeDisplay: () => document.getElementById('fee-total-display'),
            interestDisplay: () => document.getElementById('interest-total-display'),
            finalBalance: () => document.getElementById('final-balance'),
            ledgerBody: () => document.getElementById('ledger-body'),
            memberBody: () => document.getElementById('member-body'),
            settleHeader: () => document.getElementById('settle-header-row'),
            settleBody: () => document.getElementById('settle-body'),
            footerMeeting: () => document.getElementById('footer-meeting-name'),
            modal: () => document.getElementById('custom-modal'),
            modalTitle: () => document.getElementById('modal-title'),
            modalBody: () => document.getElementById('modal-body'),
            toast: () => document.getElementById('toast-message'),
            eventFilter: () => document.getElementById('event-filter'),
            filterSummary: () => document.getElementById('filter-summary'),
            imageViewer: () => document.getElementById('image-viewer'),
            viewerImg: () => document.getElementById('viewer-img')
        };

        // --- 클라우드 저장 ---
        window.saveToCloud = async () => {
            if (!isAdmin || !currentUser) return;
            if (document.activeElement && document.activeElement.id) focusTargetId = document.activeElement.id;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'meetings', currentMeetingId);
            await setDoc(docRef, appData);
        };

        window.createNewMeeting = async (name) => {
            if (!currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'meetings', name);
            const initialData = { years: [new Date().getFullYear().toString()], financeBase: {}, members: [], ledger: {}, eventNames: {}, isInactive: false };
            await setDoc(docRef, initialData);
        };

        window.ensureYearExists = (year) => {
            if (!appData.years.includes(year)) {
                appData.years.push(year);
                appData.years.sort((a, b) => b - a);
            }
            if (!appData.ledger[year]) appData.ledger[year] = [];
            if (!appData.financeBase[year]) appData.financeBase[year] = { carry: 0, monthlyFee: 10000, monthlyInterest: Array(12).fill(0) };
        };

        window.showMessage = (msg) => {
            const toast = components.toast();
            if (!toast) return;
            toast.innerText = msg;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        };

        window.openModal = (title, bodyHtml, onConfirm) => {
            components.modalTitle().innerText = title;
            components.modalBody().innerHTML = bodyHtml;
            components.modal().classList.remove('hidden');
            components.modal().classList.add('flex');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
            newBtn.onclick = async () => { if (await onConfirm() !== false) window.closeModal(); };
        };

        window.closeModal = () => {
            components.modal().classList.add('hidden');
            components.modal().classList.remove('flex');
        };

        // --- 인증 ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try { await signInWithCustomToken(auth, __initial_auth_token); } 
                    catch (e) { await signInAnonymously(auth); }
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) { console.error("Auth Error:", error); }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            isAdmin = user && !user.isAnonymous; 
            updateAuthUI();
            if (user) {
                syncMeetingList();
                startSync(currentMeetingId);
            }
        });

        function updateAuthUI() {
            const btn = components.loginBtn();
            const info = components.userInfo();
            const titleCont = components.titleContainer();
            if (!btn) return;
            
            if (isAdmin) {
                btn.innerText = "로그아웃";
                btn.classList.replace('bg-emerald-600', 'bg-slate-700');
                if (info) info.innerText = `관리자: ${currentUser.email}`;
                if (titleCont) titleCont.classList.add('admin-active');
            } else {
                btn.innerText = "관리자 로그인";
                btn.classList.replace('bg-slate-700', 'bg-emerald-600');
                if (info) info.innerText = currentUser ? "조회 전용 모드" : "인증 대기 중...";
                if (titleCont) titleCont.classList.remove('admin-active');
            }
            
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = isAdmin ? (el.classList.contains('flex-only') ? 'flex' : 'block') : 'none';
            });
            
            document.querySelectorAll('input').forEach(input => {
                if(input.id !== 'login-email' && input.id !== 'login-pw') input.disabled = !isAdmin;
            });
        }

        // --- 데이터 동기화 (깜빡임 완전 방지) ---
        const syncMeetingList = () => {
            if (!currentUser) return;
            const meetingsColl = collection(db, 'artifacts', appId, 'public', 'data', 'meetings');
            if (unsubscribeList) unsubscribeList();
            unsubscribeList = onSnapshot(meetingsColl, (snapshot) => {
                const newList = snapshot.docs.map(doc => doc.id).sort();
                const select = components.meetingSelect();
                
                // 데이터가 정말로 변했는지 깊게 비교
                const isDataChanged = JSON.stringify(meetingList) !== JSON.stringify(newList);
                
                if (isDataChanged) {
                    meetingList = newList;
                    if (meetingList.length === 0 && isAdmin) window.createNewMeeting('기본모임');
                    renderMeetingSelect();
                } else if (select && select.value !== currentMeetingId) {
                    // 리스트는 같고 선택값만 다른 경우 value만 교체
                    select.value = currentMeetingId;
                }
            });
        };

        function renderMeetingSelect() {
            const select = components.meetingSelect();
            if (!select) return;
            
            const newOptionsHtml = meetingList.map(m => 
                `<option value="${m}" ${m === currentMeetingId ? 'selected' : ''}>${m}</option>`
            ).join('');
            
            // 기존 HTML과 다를 때만 업데이트하여 깜빡임 방지
            if (select.innerHTML !== newOptionsHtml) {
                select.innerHTML = newOptionsHtml;
            }
        }

        const startSync = (meetingId) => {
            if (!currentUser) return;
            if (unsubscribeData) unsubscribeData();
            localStorage.setItem('last_meeting_id', meetingId);
            currentMeetingId = meetingId;
            
            const titleEl = components.mainTitle();
            if (titleEl && titleEl.innerText !== meetingId) titleEl.innerText = meetingId;
            if (components.footerMeeting()) components.footerMeeting().innerText = meetingId;

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'meetings', meetingId);
            unsubscribeData = onSnapshot(docRef, (snapshot) => {
                if (snapshot.exists()) {
                    appData = snapshot.data();
                    if (!currentYear && appData.years && appData.years.length > 0) {
                        currentYear = appData.years[0];
                    } else if (!currentYear) {
                        currentYear = new Date().getFullYear().toString();
                    }
                    renderAll();
                    if (focusTargetId) {
                        const el = document.getElementById(focusTargetId);
                        if (el) { el.focus(); focusTargetId = null; }
                    }
                } else if (isAdmin) {
                    appData = { years: [new Date().getFullYear().toString()], financeBase: {}, members: [], ledger: {}, eventNames: {} };
                    window.saveToCloud();
                }
            });
        };

        // --- 모임 이름 수정 ---
        window.renameMeeting = () => {
            if (!isAdmin) return;
            const bodyHtml = `<input type="text" id="rename-meeting-input" class="w-full p-4 border rounded-2xl outline-none focus:ring-2 ring-emerald-500 font-bold text-black" value="${currentMeetingId}" onkeydown="if(event.key==='Enter') document.getElementById('modal-confirm-btn').click()">`;
            window.openModal("모임 이름 수정", bodyHtml, async () => {
                const newName = document.getElementById('rename-meeting-input').value.trim();
                if (!newName || newName === currentMeetingId) return true;
                if (meetingList.includes(newName)) {
                    window.showMessage("이미 사용 중인 이름입니다.");
                    return false;
                }
                try {
                    const oldRef = doc(db, 'artifacts', appId, 'public', 'data', 'meetings', currentMeetingId);
                    const newRef = doc(db, 'artifacts', appId, 'public', 'data', 'meetings', newName);
                    await setDoc(newRef, appData);
                    await deleteDoc(oldRef);
                    startSync(newName);
                    return true;
                } catch (e) { return false; }
            });
            setTimeout(() => document.getElementById('rename-meeting-input')?.focus(), 100);
        };

        // --- 네비게이션 및 공유 ---
        window.onMeetingChange = (e) => startSync(e.target.value);
        window.changeYear = (v) => { currentYear = v; renderAll(); };
        window.addNewMeeting = () => {
            if (!isAdmin) return;
            const bodyHtml = `<input type="text" id="new-meeting-input" class="w-full p-4 border rounded-2xl outline-none focus:ring-2 ring-emerald-500 font-bold text-black" placeholder="새 모임 이름" onkeydown="if(event.key==='Enter') document.getElementById('modal-confirm-btn').click()">`;
            window.openModal("새 모임 생성", bodyHtml, () => {
                const name = document.getElementById('new-meeting-input').value.trim();
                if (!name || meetingList.includes(name)) return false;
                window.createNewMeeting(name);
                startSync(name);
                return true;
            });
            setTimeout(() => document.getElementById('new-meeting-input')?.focus(), 100);
        };
        
        window.copyShareLink = () => {
            const shareUrl = `${window.location.origin}${window.location.pathname}?m=${encodeURIComponent(currentMeetingId)}`;
            const tempInput = document.createElement('input');
            document.body.appendChild(tempInput);
            tempInput.value = shareUrl;
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            window.showMessage(`모임 전체 공유 링크가 복사되었습니다.`);
        };

        // --- 렌더링 ---
        function renderAll() {
            renderHeader();
            renderLedger();
            renderIntegratedMemberSettle();
        }

        function renderHeader() {
            if (components.titleYear()) components.titleYear().innerText = `${currentYear}년`;
            const dropdown = components.yearDropdown(); if (!dropdown) return;
            const years = [...(appData.years || [])].sort((a,b)=>b-a);
            const newYearOptions = years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
            if (dropdown.innerHTML !== newYearOptions) dropdown.innerHTML = newYearOptions;

            const base = appData.financeBase[currentYear] || { carry: 0, monthlyFee: 10000, monthlyInterest: Array(12).fill(0) };
            if (document.activeElement !== components.carryInput()) components.carryInput().value = base.carry || 0;
            
            const interestSum = (base.monthlyInterest || []).reduce((a, b) => a + b, 0);
            components.interestDisplay().innerText = interestSum.toLocaleString() + "원";
            let feeInc = 0;
            (appData.members || []).forEach(m => { if (m.paidByYear?.[currentYear]) feeInc += m.paidByYear[currentYear].filter(p => p).length * Number(base.monthlyFee); });
            components.feeDisplay().innerText = feeInc.toLocaleString() + "원";
            let ledgerBal = 0;
            (appData.ledger[currentYear] || []).forEach(r => ledgerBal += (r.type === 'income' ? r.amount : -r.amount));
            components.finalBalance().innerText = `${(Number(base.carry) + feeInc + interestSum + ledgerBal).toLocaleString()}원`;
        }

        function renderLedger() {
            const filterDropdown = components.eventFilter();
            const currentFilter = filterDropdown.value || 'all';
            const entries = appData.ledger[currentYear] || [];
            const events = [...new Set(entries.map(e => e.event))].filter(e => e).sort();
            
            const newFilterHtml = '<option value="all">전체 내역 보기</option>' + events.map(ev => `<option value="${ev}" ${ev === currentFilter ? 'selected' : ''}>${ev}</option>`).join('');
            if (filterDropdown.innerHTML !== newFilterHtml) filterDropdown.innerHTML = newFilterHtml;

            const body = components.ledgerBody(); body.innerHTML = '';
            let bal = Number(appData.financeBase[currentYear]?.carry || 0);
            let feeSum = 0;
            (appData.members || []).forEach(m => { if (m.paidByYear?.[currentYear]) feeSum += m.paidByYear[currentYear].filter(p => p).length * Number(appData.financeBase[currentYear]?.monthlyFee || 10000); });
            bal += feeSum + (appData.financeBase[currentYear]?.monthlyInterest || []).reduce((a,b)=>a+b, 0);

            [...entries].sort((a,b)=>(a.date||"").localeCompare(b.date||"")).forEach((r, idx) => {
                bal += (r.type === 'income' ? r.amount : -r.amount);
                if (currentFilter !== 'all' && r.event !== currentFilter) return;
                const tr = document.createElement('tr'); tr.className = "text-xs border-b border-slate-100 bg-white hover:bg-slate-50";
                tr.innerHTML = `
                    <td class="p-0 sticky-col bg-inherit border-r-2 border-slate-200"><input value="${r.event}" class="w-full h-11 px-3 text-center font-bold text-black outline-none bg-transparent" onchange="window.updateLedgerItem(${idx}, 'event', this.value)"></td>
                    <td class="p-0 border-r border-slate-100"><input value="${r.date}" class="w-full h-11 text-center font-mono text-black outline-none bg-transparent" placeholder="YY.MM.DD" oninput="window.formatDateInput(this)" onchange="window.updateLedgerItem(${idx}, 'date', this.value)"></td>
                    <td class="p-0 border-r border-slate-100"><input value="${r.desc}" class="w-full h-11 px-4 text-left text-black outline-none bg-transparent" onchange="window.updateLedgerItem(${idx}, 'desc', this.value)"></td>
                    <td class="p-0 border-r border-slate-100"><input type="number" value="${r.type === 'income' ? r.amount : ''}" class="w-full h-11 px-3 text-right font-black text-black outline-none bg-transparent" onchange="window.updateLedgerAmount(${idx}, 'income', this.value)"></td>
                    <td class="p-0 border-r border-slate-100"><input type="number" value="${r.type === 'expense' ? r.amount : ''}" class="w-full h-11 px-3 text-right font-black text-black outline-none bg-transparent" onchange="window.updateLedgerAmount(${idx}, 'expense', this.value)"></td>
                    <td class="p-3 text-right font-black text-black bg-black/5 border-r border-slate-200">${bal.toLocaleString()}</td>
                    <td class="p-3 border-r border-slate-100 text-center">${r.image ? `<i class="fa-solid fa-image text-emerald-500 cursor-pointer" onclick="window.openImageViewer('${r.image}')"></i>` : '-'}</td>
                    <td class="p-0 border-r border-slate-100"><input value="${r.note || ''}" class="w-full h-11 px-3 text-center italic text-black outline-none bg-transparent" onchange="window.updateLedgerItem(${idx}, 'note', this.value)"></td>
                    <td class="p-3 w-10 text-center">${isAdmin ? `<button onclick="window.deleteLedger(${idx})" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>` : ''}</td>
                `;
                body.appendChild(tr);
            });
        }

        function renderIntegratedMemberSettle() {
            const mBody = components.memberBody(); const sHead = components.settleHeader(); const sBody = components.settleBody();
            if(!mBody || !sHead || !sBody) return;
            appData.members.sort((a,b)=>a.name.localeCompare(b.name, 'ko'));
            mBody.innerHTML = '';
            const base = appData.financeBase[currentYear] || { monthlyFee: 10000, monthlyInterest: Array(12).fill(0) };
            document.getElementById('base-fee-input').value = base.monthlyFee || 10000;
            let intTr = document.createElement('tr'); intTr.className = "bg-emerald-50/50 text-[11px]";
            let intHtml = `<td class="p-3 font-black sticky left-0 z-10 border-r-2 border-emerald-200 bg-emerald-50 text-center text-black">월별 이자(+)</td>`;
            for(let i=0; i<12; i++) { intHtml += `<td class="p-1 border-r border-emerald-100 text-center"><input type="number" value="${base.monthlyInterest[i] || 0}" class="w-full text-center bg-transparent outline-none font-bold text-black" onchange="window.updateInterest(${i}, this.value)"></td>`; }
            intHtml += `<td class="bg-emerald-50/20 border-l border-emerald-100"></td>`;
            intTr.innerHTML = intHtml; mBody.appendChild(intTr);
            (appData.members || []).forEach(m => {
                const paid = (m.paidByYear?.[currentYear]) || Array(12).fill(false);
                const tr = document.createElement('tr'); tr.className = `border-b border-slate-100 text-xs bg-white ${m.isInactive?'opacity-40 grayscale line-through pointer-events-none':''}`;
                let html = `<td class="p-2 sticky left-0 z-10 border-r-2 border-slate-200 bg-inherit min-w-[250px] whitespace-nowrap"><div class="flex items-center gap-2"><span class="font-black text-black text-[15px]">${m.name}</span>${isAdmin ? `<button onclick="window.removeMember(${m.id})" class="text-slate-300 hover:text-red-500"><i class="fa-solid ${m.isInactive ? 'fa-rotate-left' : 'fa-trash-can'} text-[11px]"></i></button>` : ''}</div></td>`;
                paid.forEach((p, i) => { html += `<td class="p-1 border-r border-slate-100 text-center"><div onclick="window.toggleMemberPaid(${m.id}, ${i})" class="w-8 h-8 mx-auto flex items-center justify-center rounded-lg cursor-pointer ${p ? 'bg-emerald-600 text-white' : 'border border-slate-200'}"><i class="fa-solid fa-check text-xs"></i></div></td>`; });
                html += `<td class="p-1 border-r border-slate-100 min-w-[150px]"><input value="${m.memoByYear?.[currentYear] || ''}" class="w-full h-8 px-2 outline-none font-medium text-black bg-transparent" onchange="window.updateMemberMemo(${m.id}, this.value)"></td>`;
                tr.innerHTML = html; mBody.appendChild(tr);
            });
        }

        // --- 기타 로직 ---
        window.updateMonthlyFee = (v) => { if(!isAdmin) return; appData.financeBase[currentYear].monthlyFee = Number(v) || 0; window.saveToCloud(); };
        window.updateCarryOver = (v) => { if(!isAdmin) return; appData.financeBase[currentYear].carry = Number(v) || 0; window.saveToCloud(); };
        window.updateInterest = (idx, v) => { if(!isAdmin) return; appData.financeBase[currentYear].monthlyInterest[idx] = Number(v) || 0; window.saveToCloud(); };
        window.updateMemberMemo = (id, v) => { if(!isAdmin) return; const m = appData.members.find(x => x.id === id); if(!m.memoByYear) m.memoByYear = {}; m.memoByYear[currentYear] = v; window.saveToCloud(); };
        window.toggleMemberPaid = (mid, idx) => { if(!isAdmin) return; const m = appData.members.find(x => x.id === mid); if(!m.paidByYear[currentYear]) m.paidByYear[currentYear] = Array(12).fill(false); m.paidByYear[currentYear][idx] = !m.paidByYear[currentYear][idx]; window.saveToCloud(); };
        window.removeMember = (id) => { if(!isAdmin) return; const m = appData.members.find(x => x.id === id); m.isInactive = !m.isInactive; window.saveToCloud(); };
        window.updateLedgerItem = (idx, f, v) => { if(!isAdmin) return; appData.ledger[currentYear][idx][f] = v; window.saveToCloud(); };
        window.updateLedgerAmount = (idx, t, v) => { if(!isAdmin) return; appData.ledger[currentYear][idx].type = t; appData.ledger[currentYear][idx].amount = Number(v) || 0; window.saveToCloud(); };
        window.addLedgerRow = () => { if(!isAdmin) return; appData.ledger[currentYear].push({ event: "", date: "", desc: "", type: "expense", amount: 0, note: "", image: "" }); window.saveToCloud(); };
        window.deleteLedger = (idx) => { if(!isAdmin) return; appData.ledger[currentYear].splice(idx, 1); window.saveToCloud(); };
        window.formatDateInput = (el) => { el.value = el.value.replace(/[^0-9.]/g, ''); };
        window.switchView = (id) => { document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden')); document.getElementById(`view-${id}`)?.classList.remove('hidden'); document.querySelectorAll('nav button').forEach(b => b.classList.remove('active', 'text-emerald-700', 'border-emerald-700', 'bg-emerald-50')); document.getElementById(`tab-${id}`)?.classList.add('active', 'text-emerald-700', 'border-emerald-700', 'bg-emerald-50'); };
        window.openImageViewer = (src) => { components.viewerImg().src = src; components.imageViewer().classList.remove('hidden'); components.imageViewer().classList.add('flex'); };
        window.closeImageViewer = () => components.imageViewer().classList.add('hidden');
        
        window.handleAuth = async () => { 
            if (isAdmin) { 
                window.openModal("로그아웃", "로그아웃 하시겠습니까?", async () => { await signOut(auth); window.location.reload(); return true; }); 
            } else { 
                const bodyHtml = `
                    <div class="space-y-4">
                        <input type="email" id="login-email" class="w-full p-4 border rounded-2xl text-black outline-none focus:ring-2 ring-emerald-500" placeholder="관리자 이메일" onkeydown="if(event.key==='Enter') document.getElementById('login-pw').focus()">
                        <input type="password" id="login-pw" class="w-full p-4 border rounded-2xl text-black outline-none focus:ring-2 ring-emerald-500" placeholder="비밀번호" onkeydown="if(event.key==='Enter') document.getElementById('modal-confirm-btn').click()">
                    </div>`; 
                window.openModal("관리자 로그인", bodyHtml, async () => { 
                    const email = document.getElementById('login-email').value; 
                    const pw = document.getElementById('login-pw').value; 
                    try { 
                        await signInWithEmailAndPassword(auth, email, pw); 
                        window.showMessage("로그인 성공!");
                        return true; 
                    } catch (e) { 
                        window.showMessage("로그인 실패: 정보를 확인하세요."); 
                        return false; 
                    } 
                }); 
                setTimeout(() => document.getElementById('login-email')?.focus(), 100);
            } 
        };
        
        initAuth();
        window.onload = () => { switchView('ledger'); };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; color: #334155; }
        .tab-btn { border-bottom: 4px solid transparent; transition: all 0.2s; }
        .tab-btn.active { border-bottom-color: #059669; }
        input:focus { background-color: #f0fdf4 !important; border-bottom: 2px solid #10b981 !important; outline: none; }
        .sticky-col { position: sticky; left: 0; z-index: 10; border-right: 2px solid #e2e8f0 !important; }
        .admin-only { display: none; }
        #carry-over-input { color: white !important; }
        #carry-over-input:focus { color: black !important; background-color: white !important; }
        main input, .modal input, select { color: #000000 !important; }
        
        /* 제목 디자인 */
        .admin-active h1 { cursor: pointer; transition: color 0.2s; }
        .admin-active h1:hover { color: #10b981; }
        .edit-icon { font-size: 0.5em; vertical-align: middle; margin-left: 10px; opacity: 0.5; transition: opacity 0.2s; display: none; }
        .admin-active .edit-icon { display: inline-block; cursor: pointer; }
        .admin-active .edit-icon:hover { opacity: 1; }
    </style>
</head>
<body class="min-h-screen">
    <div id="datalist-container"></div>
    <input type="file" id="excel-upload" class="hidden" onchange="window.handleExcelUpload(event)">
    <div id="toast-message" class="fixed top-5 left-1/2 -translate-x-1/2 z-[100] bg-slate-800 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl opacity-0 transition-opacity duration-300 pointer-events-none"></div>

    <div id="image-viewer" class="fixed inset-0 bg-black/90 z-[110] hidden items-center justify-center p-4 cursor-pointer" onclick="window.closeImageViewer()">
        <img id="viewer-img" src="" class="max-w-full max-h-full rounded-lg shadow-2xl object-contain">
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-black/60 z-[90] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl animate-in fade-in zoom-in duration-300">
            <div class="p-6"><h3 id="modal-title" class="text-lg font-black text-slate-900 mb-4 text-center border-b pb-2">알림</h3><div id="modal-body" class="text-slate-600 text-sm"></div></div>
            <div class="flex border-t"><button onclick="window.closeModal()" class="flex-1 py-4 text-sm font-bold text-slate-400 hover:bg-slate-50 transition-colors">취소</button><button id="modal-confirm-btn" class="flex-1 py-4 text-sm font-black text-emerald-600 border-l hover:bg-emerald-50 transition-colors">확인</button></div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto bg-white shadow-2xl min-h-screen flex flex-col border-x border-gray-200">
        <div class="bg-slate-900 text-white text-[11px] p-2.5 px-5 flex flex-wrap gap-y-2 justify-between items-center shadow-md">
            <div class="flex items-center flex-wrap gap-3">
                <div class="flex items-center bg-white rounded-full pr-1 w-[220px] shrink-0 shadow-sm">
                    <div class="flex items-center gap-1.5 px-3 py-1.5 overflow-hidden w-full"><i class="fa-solid fa-users text-emerald-600"></i><span class="font-black text-slate-400 shrink-0">모임</span><select id="meeting-select" onchange="window.onMeetingChange(event)" class="bg-transparent text-black font-black outline-none cursor-pointer w-full truncate"></select></div>
                    <button onclick="window.addNewMeeting()" class="bg-emerald-600 w-7 h-7 shrink-0 rounded-full flex items-center justify-center admin-only hover:bg-emerald-500 transition-colors"><i class="fa-solid fa-plus text-[10px]"></i></button>
                </div>
                <div class="flex items-center bg-white rounded-full pr-1 w-[160px] shrink-0 shadow-sm">
                    <div class="flex items-center gap-1.5 px-3 py-1.5 w-full"><i class="fa-solid fa-calendar-days text-emerald-600"></i><span class="font-black text-slate-400 shrink-0">연도</span><select id="year-dropdown" onchange="window.changeYear(this.value)" class="bg-transparent text-black font-black outline-none cursor-pointer w-full"></select></div>
                    <button onclick="window.addNewYear()" class="bg-emerald-600 w-7 h-7 shrink-0 rounded-full flex items-center justify-center admin-only hover:bg-emerald-500 transition-colors"><i class="fa-solid fa-plus text-[10px]"></i></button>
                </div>
                <button onclick="window.copyShareLink()" class="bg-slate-700 text-white px-4 py-1.5 rounded-full flex items-center gap-2 shrink-0 shadow-md hover:bg-slate-600 active:scale-95 transition-all"><i class="fa-solid fa-share-nodes text-[10px]"></i><span class="font-black text-[10px]">링크공유</span></button>
            </div>
            <div class="flex gap-2 shrink-0">
                <button onclick="window.downloadTemplate()" class="bg-slate-700 px-3 py-1.5 rounded-lg font-black admin-only shadow-sm hover:bg-slate-600">양식다운</button>
                <button onclick="window.triggerUpload()" class="bg-slate-700 px-3 py-1.5 rounded-lg font-black admin-only shadow-sm hover:bg-slate-600">업로드</button>
                <button id="loginBtn" onclick="window.handleAuth()" class="bg-emerald-600 px-3 py-1.5 rounded-lg font-black min-w-[100px] shadow-lg transition-all active:scale-95 hover:bg-emerald-500">관리자 로그인</button>
            </div>
        </div>

        <header class="bg-gradient-to-br from-emerald-900 to-slate-900 text-white p-8 relative overflow-hidden">
            <div id="title-container" class="flex justify-between items-end mb-8 relative z-10">
                <div class="flex items-center gap-3">
                    <h1 id="main-title" onclick="window.renameMeeting()" class="text-3xl font-black tracking-tighter">기본모임</h1>
                    <i class="fa-solid fa-pen-to-square edit-icon" onclick="window.renameMeeting()"></i>
                    <span id="title-year" class="text-emerald-500 font-medium text-lg ml-2"></span>
                </div>
                <div id="user-info" class="text-[10px] font-black uppercase text-slate-500 text-right tracking-widest"></div>
            </div>
            <div class="grid grid-cols-3 gap-4 relative z-10 mb-4 text-center">
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10 backdrop-blur-md">
                    <p class="text-[10px] text-emerald-400 font-black mb-1 opacity-80 uppercase tracking-tighter">이월액</p>
                    <input type="number" id="carry-over-input" onchange="window.updateCarryOver(this.value)" class="bg-transparent text-lg font-black w-full outline-none text-center rounded-lg transition-all" placeholder="0">
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10 backdrop-blur-md"><p class="text-[10px] text-emerald-400 font-black mb-1 opacity-80 uppercase tracking-tighter">회비 합계</p><h3 id="fee-total-display" class="text-lg font-black text-white">0원</h3></div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10 backdrop-blur-md"><p class="text-[10px] text-emerald-400 font-black mb-1 opacity-80 uppercase tracking-tighter">이자 합계</p><h3 id="interest-total-display" class="text-lg font-black text-white">0원</h3></div>
            </div>
            <div class="bg-emerald-500 p-5 rounded-2xl shadow-2xl border border-emerald-400/30 relative z-10"><div class="flex justify-between items-center"><p class="text-[11px] text-emerald-900 font-black italic uppercase tracking-widest">현재 총 잔액</p><h3 id="final-balance" class="text-3xl font-black text-white tracking-tighter">0원</h3></div></div>
        </header>

        <nav class="flex items-center border-b sticky top-0 bg-white/90 backdrop-blur-lg z-20 shadow-sm">
            <button id="tab-ledger" onclick="window.switchView('ledger')" class="tab-btn flex-1 py-5 text-sm font-black text-slate-400 active">장부 기록</button>
            <button id="tab-member" onclick="window.switchView('member')" class="tab-btn flex-1 py-5 text-sm font-black text-slate-400">명부 및 정산</button>
        </nav>

        <main class="p-6 flex-1 bg-slate-50/30">
            <div id="view-ledger" class="space-y-4">
                <div class="flex items-center justify-between">
                    <select id="event-filter" onchange="window.applyFilter()" class="bg-white border border-slate-200 rounded-full px-4 py-2 text-xs font-bold text-black min-w-[120px] outline-none shadow-sm cursor-pointer"></select>
                    <div id="filter-summary"></div>
                </div>
                <div class="overflow-x-auto rounded-3xl border border-slate-200 bg-white shadow-xl">
                    <table class="w-full text-center border-collapse">
                        <thead class="bg-slate-50 text-slate-400 text-[10px] font-black uppercase border-b border-slate-200">
                            <tr><th class="p-4 sticky-col bg-slate-50 border-r-2 border-slate-200">행사명</th><th class="p-4 border-r border-slate-100">날짜</th><th class="p-4 border-r border-slate-100">상세내역</th><th class="p-4 border-r border-slate-100">입금</th><th class="p-4 border-r border-slate-100">지출</th><th class="p-4 bg-black/5 border-r border-slate-200">잔액</th><th class="p-4 border-r border-slate-100">영수증</th><th class="p-4 border-r border-slate-100">비고</th><th class="p-4 admin-only"></th></tr>
                        </thead>
                        <tbody id="ledger-body"></tbody>
                    </table>
                </div>
                <button onclick="window.addLedgerRow()" class="w-full py-6 border-2 border-dashed border-slate-200 text-slate-400 font-black rounded-3xl hover:bg-white hover:border-emerald-300 admin-only flex-only items-center justify-center transition-all group"><i class="fa-solid fa-circle-plus mr-2 text-lg group-hover:scale-110 transition-transform"></i>거래 내역 추가</button>
            </div>
            
            <div id="view-member" class="hidden space-y-10">
                <section class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-black text-slate-800 tracking-tight">회원 명부 및 월납 현황</h2>
                        <div class="admin-only flex gap-2 items-center">
                            <input type="number" id="base-fee-input" class="w-20 p-2 text-sm font-bold border border-slate-200 rounded-xl outline-none shadow-sm" onchange="window.updateMonthlyFee(this.value)">
                            <input type="text" id="new-mem-name" placeholder="이름" class="w-24 p-2.5 border border-slate-200 rounded-xl text-sm font-bold outline-none shadow-sm">
                            <input type="text" id="new-mem-phone" placeholder="전화번호" class="w-32 p-2.5 border border-slate-200 rounded-xl text-sm font-bold outline-none shadow-sm">
                            <button onclick="window.addMember()" class="bg-slate-900 text-white px-6 rounded-xl text-sm font-black hover:bg-emerald-700 shadow-md transition-colors active:scale-95">등록</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto rounded-3xl border border-slate-200 bg-white shadow-2xl">
                        <table class="w-full text-center border-collapse">
                            <thead class="bg-slate-100 text-[10px] text-slate-500 font-black border-b border-slate-200">
                                <tr><th class="p-4 sticky left-0 z-20 bg-slate-100 border-r-2 border-slate-200 min-w-[250px] text-black">회원 정보</th><th class="p-2 border-r border-slate-100">1</th><th class="p-2 border-r border-slate-100">2</th><th class="p-2 border-r border-slate-100">3</th><th class="p-2 border-r border-slate-100">4</th><th class="p-2 border-r border-slate-100">5</th><th class="p-2 border-r border-slate-100">6</th><th class="p-2 border-r border-slate-100">7</th><th class="p-2 border-r border-slate-100">8</th><th class="p-2 border-r border-slate-100">9</th><th class="p-2 border-r border-slate-100">10</th><th class="p-2 border-r border-slate-100">11</th><th class="p-2 border-r border-slate-100">12</th><th class="p-4 min-w-[150px] text-black border-l border-slate-200">비고</th></tr>
                            </thead>
                            <tbody id="member-body"></tbody>
                        </table>
                    </div>
                </section>
                <section class="space-y-4">
                    <h2 class="text-xl font-black text-slate-800 tracking-tight">년도별 회비 정산 요약</h2>
                    <div class="overflow-x-auto rounded-3xl border border-slate-200 bg-white shadow-2xl">
                        <table class="w-full text-center border-collapse">
                            <thead id="settle-header-row" class="bg-slate-100 font-black text-slate-500 border-b-2 text-black"></thead>
                            <tbody id="settle-body"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
        <footer class="p-8 text-center text-[10px] text-black border-t bg-slate-50 font-bold uppercase tracking-widest">&copy; 2026 <span id="footer-meeting-name"></span> 황제모임 재정 관리 시스템.</footer>
    </div>
</body>
</html>