<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>황제모임 가계부 관리 시스템</title>
    <!-- 외부 라이브러리: Tailwind CSS, FontAwesome, SheetJS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithEmailAndPassword, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 사용자 제공 Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyABPfmRxiNzND5O8KdgP7QtHdQ0Mf74nMc",
            authDomain: "hwangje-moim.firebaseapp.com",
            projectId: "hwangje-moim",
            storageBucket: "hwangje-moim.firebasestorage.app",
            messagingSenderId: "358129736978",
            appId: "1:358129736978:web:45ea7c0db8fb61215b27cb"
        };

        const appId = "hwangje-moim-finance"; 

        // 초기화
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 상태 변수
        const urlParams = new URLSearchParams(window.location.search);
        let currentMeetingId = urlParams.get('m') || localStorage.getItem('last_meeting_id') || '기본모임';
        let currentYear = urlParams.get('y') || new Date().getFullYear().toString();
        
        let appData = { years: [currentYear], financeBase: {}, members: [], ledger: {}, eventNames: {} };
        let isAdmin = false;
        let currentUser = null;
        let unsubscribeData = null;
        let unsubscribeList = null;
        let meetingList = [];
        let focusTargetId = null;

        const components = {
            meetingSelect: () => document.getElementById('meeting-select'),
            userInfo: () => document.getElementById('user-info'),
            loginBtn: () => document.getElementById('loginBtn'),
            titleYear: () => document.getElementById('title-year'),
            mainTitle: () => document.getElementById('main-title'),
            yearDropdown: () => document.getElementById('year-dropdown'),
            carryInput: () => document.getElementById('carry-over-input'),
            feeDisplay: () => document.getElementById('fee-total-display'),
            interestDisplay: () => document.getElementById('interest-total-display'),
            finalBalance: () => document.getElementById('final-balance'),
            ledgerBody: () => document.getElementById('ledger-body'),
            memberBody: () => document.getElementById('member-body'),
            settleHeader: () => document.getElementById('settle-header-row'),
            settleBody: () => document.getElementById('settle-body'),
            footerMeeting: () => document.getElementById('footer-meeting-name'),
            modal: () => document.getElementById('custom-modal'),
            modalTitle: () => document.getElementById('modal-title'),
            modalBody: () => document.getElementById('modal-body'),
            toast: () => document.getElementById('toast-message'),
            eventFilter: () => document.getElementById('event-filter'),
            filterSummary: () => document.getElementById('filter-summary'),
            imageViewer: () => document.getElementById('image-viewer'),
            viewerImg: () => document.getElementById('viewer-img')
        };

        // --- 클라우드 저장 및 동기화 ---
        window.saveToCloud = async () => {
            if (!isAdmin || !currentUser) return;
            if (document.activeElement && document.activeElement.id) focusTargetId = document.activeElement.id;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'meetings', currentMeetingId);
            await setDoc(docRef, appData);
        };

        window.createNewMeeting = async (name) => {
            if (!currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'meetings', name);
            const initialData = { years: [new Date().getFullYear().toString()], financeBase: {}, members: [], ledger: {}, eventNames: {}, isInactive: false };
            await setDoc(docRef, initialData);
        };

        window.ensureYearExists = (year) => {
            if (!appData.years.includes(year)) {
                appData.years.push(year);
                appData.years.sort((a, b) => b - a);
            }
            if (!appData.ledger[year]) appData.ledger[year] = [];
            if (!appData.financeBase[year]) appData.financeBase[year] = { carry: 0, monthlyFee: 10000, monthlyInterest: Array(12).fill(0) };
            if (!appData.eventNames[year]) appData.eventNames[year] = [];
        };

        // --- 공통 UI 핸들러 ---
        window.showMessage = (msg) => {
            const toast = components.toast();
            if (!toast) return;
            toast.innerText = msg;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        };

        window.openModal = (title, bodyHtml, onConfirm) => {
            components.modalTitle().innerText = title;
            components.modalBody().innerHTML = bodyHtml;
            components.modal().classList.remove('hidden');
            components.modal().classList.add('flex');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
            newBtn.onclick = async () => { if (await onConfirm() !== false) window.closeModal(); };
        };

        window.closeModal = () => {
            components.modal().classList.add('hidden');
            components.modal().classList.remove('flex');
        };

        window.openImageViewer = (src) => {
            if(!src) return;
            components.viewerImg().src = src;
            components.imageViewer().classList.remove('hidden');
            components.imageViewer().classList.add('flex');
        };

        window.closeImageViewer = () => {
            components.imageViewer().classList.add('hidden');
            components.imageViewer().classList.remove('flex');
        };

        // --- 인증 로직 (Fix: auth/admin-restricted-operation & Rule 3 적용) ---
        const initAuth = async () => {
            try {
                // 1. 시스템 토큰 확인 및 시도
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (e) {
                        console.warn("System token failure, trying fallback:", e.code);
                        await signInAnonymously(auth);
                    }
                } else {
                    // 2. 익명 로그인 시도
                    await signInAnonymously(auth);
                }
            } catch (error) { 
                console.error("Auth Error:", error); 
                if (error.code === 'auth/admin-restricted-operation') {
                    window.openModal(
                        "인증 설정 안내", 
                        "회원 조회를 위해 Firebase 콘솔에서 '익명 로그인'을 활성화해야 합니다.<br><br><b>조치 방법:</b><br>1. Firebase 콘솔 접속<br>2. Authentication > Sign-in method<br>3. '익명(Anonymous)' 활성화 후 저장", 
                        () => true
                    );
                }
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            isAdmin = user && !user.isAnonymous; 
            updateAuthUI();
            if (user) {
                // Rule 3: 인증 완료 후에만 Firestore 리스너 시작
                syncMeetingList();
                startSync(currentMeetingId);
            }
        });

        function updateAuthUI() {
            const info = components.userInfo();
            if (!info) return;
            info.innerText = isAdmin ? `관리자: ${currentUser.email}` : (currentUser ? "조회 모드" : "인증 대기 중...");
            components.loginBtn().innerText = isAdmin ? "로그아웃" : "관리자 로그인";
            
            document.querySelectorAll('.admin-only').forEach(el => {
                if (el.tagName === 'BUTTON' || el.classList.contains('flex-only')) {
                    el.style.display = isAdmin ? 'flex' : 'none';
                } else {
                    el.style.display = isAdmin ? 'block' : 'none';
                }
            });
            
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                if(input.id !== 'login-email' && input.id !== 'login-pw') {
                    input.disabled = !isAdmin;
                }
            });
        }

        // --- 데이터 동기화 리스너 ---
        const syncMeetingList = () => {
            if (!currentUser) return;
            const meetingsColl = collection(db, 'artifacts', appId, 'public', 'data', 'meetings');
            if (unsubscribeList) unsubscribeList();
            unsubscribeList = onSnapshot(meetingsColl, (snapshot) => {
                meetingList = snapshot.docs.map(doc => doc.id);
                if (meetingList.length === 0 && isAdmin) window.createNewMeeting('기본모임');
                renderMeetingSelect();
            }, (error) => {
                console.error("Meeting List Access Error:", error);
            });
        };

        function renderMeetingSelect() {
            const select = components.meetingSelect();
            if (!select) return;
            select.innerHTML = '';
            meetingList.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.innerText = m;
                if (m === currentMeetingId) opt.selected = true;
                select.appendChild(opt);
            });
        }

        const startSync = (meetingId) => {
            if (!currentUser) return;
            if (unsubscribeData) unsubscribeData();
            localStorage.setItem('last_meeting_id', meetingId);
            currentMeetingId = meetingId;
            components.mainTitle().innerText = meetingId;
            if (components.footerMeeting()) components.footerMeeting().innerText = meetingId;

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'meetings', meetingId);
            unsubscribeData = onSnapshot(docRef, (snapshot) => {
                if (snapshot.exists()) {
                    appData = snapshot.data();
                    renderAll();
                    if (focusTargetId) {
                        const el = document.getElementById(focusTargetId);
                        if (el) {
                            el.focus();
                            if (el.setSelectionRange && el.type === 'text') {
                                const len = el.value.length;
                                el.setSelectionRange(len, len);
                            }
                        }
                        focusTargetId = null;
                    }
                } else if (isAdmin) {
                    appData = { years: [currentYear], financeBase: {}, members: [], ledger: {}, eventNames: {} };
                    window.saveToCloud();
                }
            }, (error) => {
                console.error("Data Sync Access Error:", error);
            });
        };

        // --- 상단 네비게이션 액션 ---
        window.onMeetingChange = (e) => startSync(e.target.value);

        window.renameMeeting = () => {
            if (!isAdmin) return;
            const bodyHtml = `<input type="text" id="rename-meeting-input" ondblclick="this.select()" onkeydown="if(event.key==='Enter') { event.preventDefault(); document.getElementById('modal-confirm-btn').click(); }" class="w-full p-3 border rounded-xl outline-none focus:ring-2 ring-emerald-500 font-bold text-black" value="${currentMeetingId}">`;
            window.openModal("모임 이름 수정", bodyHtml, async () => {
                const newName = document.getElementById('rename-meeting-input').value.trim();
                if (!newName || newName === currentMeetingId) return true;
                if (meetingList.includes(newName)) return false;
                try {
                    const oldId = currentMeetingId;
                    const oldRef = doc(db, 'artifacts', appId, 'public', 'data', 'meetings', oldId);
                    const newRef = doc(db, 'artifacts', appId, 'public', 'data', 'meetings', newName);
                    await setDoc(newRef, appData);
                    if (unsubscribeData) { unsubscribeData(); unsubscribeData = null; }
                    await deleteDoc(oldRef);
                    currentMeetingId = newName;
                    localStorage.setItem('last_meeting_id', newName);
                    startSync(newName);
                    return true;
                } catch (e) { return false; }
            });
        };

        window.addNewYear = () => {
            if (!isAdmin) return;
            const bodyHtml = `<input type="number" id="new-year-input" ondblclick="this.select()" onkeydown="if(event.key==='Enter') { event.preventDefault(); document.getElementById('modal-confirm-btn').click(); }" class="w-full p-3 border rounded-xl outline-none focus:ring-2 ring-emerald-500 font-bold text-center text-black" placeholder="연도 입력 (예: 2026)">`;
            window.openModal("연도 추가", bodyHtml, () => {
                const year = document.getElementById('new-year-input').value.trim();
                if (!year || year.length !== 4) {
                    window.showMessage("4자리 연도를 입력해주세요.");
                    return false;
                }
                window.ensureYearExists(year);
                currentYear = year;
                window.saveToCloud();
                return true;
            });
            setTimeout(() => document.getElementById('new-year-input')?.focus(), 100);
        };

        window.copyShareLink = () => {
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?m=${encodeURIComponent(currentMeetingId)}&y=${currentYear}`;
            const tempInput = document.createElement('input');
            document.body.appendChild(tempInput);
            tempInput.value = shareUrl;
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            window.showMessage(`링크가 복사되었습니다.`);
        };

        window.downloadTemplate = () => {
            const ledgerWS = XLSX.utils.json_to_sheet([{ "행사명": "정기모임", "날짜": "26.01.15", "상세내역": "식대 결제", "구분(입금/지출)": "지출", "금액": 50000, "비고": "카드" }]);
            const memberWS = XLSX.utils.json_to_sheet([{ "이름": "홍길동", "전화번호": "010-0000-0000", "추가정보1": "서울", "추가정보2": "회장" }]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ledgerWS, "장부내역");
            XLSX.utils.book_append_sheet(wb, memberWS, "회원명단");
            XLSX.writeFile(wb, `황제모임_데이터양식.xlsx`);
        };

        window.triggerUpload = () => document.getElementById('excel-upload').click();
        window.handleExcelUpload = (event) => {
            const file = event.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const ledgerSheet = workbook.Sheets["장부내역"];
                if(ledgerSheet) {
                    const rows = XLSX.utils.sheet_to_json(ledgerSheet);
                    appData.ledger[currentYear] = rows.map(r => ({ event: r["행사명"] || "", date: r["날짜"] || "", desc: r["상세내역"] || "", type: r["구분(입금/지출)"] === "입금" ? "income" : "expense", amount: Number(r["금액"]) || 0, note: r["비고"] || "", image: "" }));
                }
                const memberSheet = workbook.Sheets["회원명단"];
                if(memberSheet) {
                    const rows = XLSX.utils.sheet_to_json(memberSheet);
                    appData.members = rows.map(r => {
                        const details = []; if(r["추가정보1"]) details.push(String(r["추가정보1"])); if(r["추가정보2"]) details.push(String(r["추가정보2"]));
                        return { id: Date.now() + Math.random(), name: r["이름"] || "무명", phone: r["전화번호"] || "", details: details, memoByYear: {}, paidByYear: {}, isInactive: false };
                    });
                }
                window.saveToCloud(); window.showMessage("데이터가 업로드되었습니다."); event.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        };

        // --- 메인 렌더링 함수 ---
        function renderAll() {
            renderHeader();
            renderLedger();
            renderIntegratedMemberSettle();
        }

        function renderHeader() {
            components.titleYear().innerText = `${currentYear}년`;
            const dropdown = components.yearDropdown(); if (!dropdown) return;
            dropdown.innerHTML = '';
            [...(appData.years || [])].sort((a, b) => b - a).forEach(y => {
                const opt = document.createElement('option'); opt.value = y; opt.innerText = y;
                if (y === currentYear) opt.selected = true; dropdown.appendChild(opt);
            });
            const base = appData.financeBase[currentYear] || { carry: 0, monthlyFee: 10000, monthlyInterest: Array(12).fill(0) };
            
            const carryInput = components.carryInput();
            carryInput.value = base.carry || 0;
            carryInput.disabled = !isAdmin;

            const interestSum = (base.monthlyInterest || []).reduce((a, b) => a + b, 0);
            components.interestDisplay().innerText = interestSum.toLocaleString() + "원";
            let feeInc = 0;
            (appData.members || []).forEach(m => { if (m.paidByYear?.[currentYear]) feeInc += m.paidByYear[currentYear].filter(p => p).length * Number(base.monthlyFee); });
            components.feeDisplay().innerText = feeInc.toLocaleString() + "원";
            
            let ledgerBalance = 0;
            (appData.ledger[currentYear] || []).forEach(r => ledgerBalance += (r.type === 'income' ? r.amount : -r.amount));
            const total = Number(base.carry) + feeInc + interestSum + ledgerBalance;
            components.finalBalance().innerText = `${total.toLocaleString()}원`;
        }

        function renderLedger() {
            const filterDropdown = components.eventFilter();
            const currentFilter = filterDropdown.value || 'all';
            const ledgerEntries = appData.ledger[currentYear] || [];
            const registeredEvents = appData.eventNames[currentYear] || [];
            const ledgerEvents = ledgerEntries.map(e => e.event).filter(e => e);
            const allUniqueEvents = [...new Set([...registeredEvents, ...ledgerEvents])].sort();
            const colorMap = {};
            allUniqueEvents.forEach((ev, idx) => { colorMap[ev] = palette[idx % palette.length]; });

            filterDropdown.innerHTML = '<option value="all">전체 내역 보기</option>';
            allUniqueEvents.forEach(ev => {
                const opt = document.createElement('option'); opt.value = ev; opt.innerText = ev;
                if(ev === currentFilter) opt.selected = true; filterDropdown.appendChild(opt);
            });

            const body = components.ledgerBody();
            body.innerHTML = '';
            let runningBalance = Number(appData.financeBase[currentYear]?.carry || 0);
            let feeSum = 0;
            (appData.members || []).forEach(m => { if (m.paidByYear?.[currentYear]) feeSum += m.paidByYear[currentYear].filter(p => p).length * Number(appData.financeBase[currentYear]?.monthlyFee || 10000); });
            runningBalance += feeSum + (appData.financeBase[currentYear]?.monthlyInterest || []).reduce((a,b) => a+b, 0);

            let allSorted = [...ledgerEntries].sort((a, b) => (a.date || "").localeCompare(b.date || ""));
            
            allSorted.forEach((r, idx) => {
                const amtIn = r.type === 'income' ? r.amount : 0; const amtOut = r.type === 'expense' ? r.amount : 0;
                runningBalance += (amtIn - amtOut); if (currentFilter !== 'all' && r.event !== currentFilter) return;
                const tr = document.createElement('tr'); tr.className = `${colorMap[r.event] || 'bg-white'} text-xs border-b border-slate-100 group transition-all`;
                const receiptHtml = r.image ? `<img src="${r.image}" class="w-8 h-8 object-cover rounded cursor-pointer mx-auto shadow-sm" onclick="window.openImageViewer('${r.image}')">` : (isAdmin ? `<label class="cursor-pointer text-slate-300 hover:text-emerald-500"><i class="fa-solid fa-camera"></i><input type="file" accept="image/*" class="hidden" onchange="window.handleImageUpload(event, ${idx})"></label>` : '-');
                tr.innerHTML = `
                    <td class="p-0 sticky-col bg-inherit border-r-2 border-slate-200 text-center"><input id="ledger-${idx}-event" list="event-datalist" value="${r.event}" ondblclick="this.select()" class="w-full h-11 px-3 text-center font-bold text-black outline-none bg-transparent" ${!isAdmin?'disabled':''} onchange="window.updateLedgerItem(${idx}, 'event', this.value)"></td>
                    <td class="p-0 border-r border-slate-100 text-center"><input id="ledger-${idx}-date" type="text" value="${r.date}" ondblclick="this.select()" class="w-full h-11 text-center font-mono text-black outline-none bg-transparent" placeholder="YY.MM.DD" ${!isAdmin?'disabled':''} oninput="window.formatDateInput(this)" onchange="window.updateLedgerItem(${idx}, 'date', this.value)"></td>
                    <td class="p-0 border-r border-slate-100 text-center"><input id="ledger-${idx}-desc" type="text" value="${r.desc}" ondblclick="this.select()" class="w-full h-11 px-4 text-left text-black outline-none bg-transparent" ${!isAdmin?'disabled':''} onchange="window.updateLedgerItem(${idx}, 'desc', this.value)"></td>
                    <td class="p-0 border-r border-slate-100 text-center"><input id="ledger-${idx}-income" type="number" value="${r.type === 'income' ? r.amount : ''}" ondblclick="this.select()" class="w-full h-11 px-3 text-right font-black text-black outline-none bg-transparent" ${!isAdmin?'disabled':''} onchange="window.updateLedgerAmount(${idx}, 'income', this.value)"></td>
                    <td class="p-0 border-r border-slate-100 text-center"><input id="ledger-${idx}-expense" type="number" value="${r.type === 'expense' ? r.amount : ''}" ondblclick="this.select()" class="w-full h-11 px-3 text-right font-black text-black outline-none bg-transparent" ${!isAdmin?'disabled':''} onchange="window.updateLedgerAmount(${idx}, 'expense', this.value)"></td>
                    <td class="p-3 text-right font-black text-black bg-black/5 border-r border-slate-200">${runningBalance.toLocaleString()}</td>
                    <td class="p-0 border-r border-slate-100 text-center">${receiptHtml}</td>
                    <td class="p-0 border-r border-slate-100 text-center"><input id="ledger-${idx}-note" type="text" value="${r.note || ''}" ondblclick="this.select()" class="w-full h-11 px-3 text-center italic text-black outline-none bg-transparent" ${!isAdmin?'disabled':''} onchange="window.updateLedgerItem(${idx}, 'note', this.value)" onkeydown="window.handleLedgerEnter(event, ${idx})"></td>
                    <td class="p-3 w-10 text-center opacity-0 group-hover:opacity-100">${isAdmin ? `<button onclick="window.deleteLedger(${idx})" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>` : ''}</td>
                `;
                body.appendChild(tr);
            });
            if (currentFilter !== 'all') components.filterSummary().innerHTML = `<div class="bg-emerald-50 px-4 py-2 rounded-xl text-[11px] font-bold text-emerald-800 border border-emerald-100 shadow-sm">전체 정산: ${(runningBalance).toLocaleString()}원</div>`;
            else components.filterSummary().innerHTML = `<span class="text-slate-400 font-bold text-xs">전체 ${ledgerEntries.length}건</span>`;
        }

        function renderIntegratedMemberSettle() {
            const mBody = components.memberBody(); const sHead = components.settleHeader(); const sBody = components.settleBody();
            if(!mBody || !sHead || !sBody) return;
            appData.members.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
            const memberColorMap = {}; appData.members.forEach((m, idx) => { memberColorMap[m.name] = palette[idx % palette.length]; });
            mBody.innerHTML = '';
            const base = appData.financeBase[currentYear] || { monthlyInterest: Array(12).fill(0), monthlyFee: 10000 };
            const baseFeeInput = document.getElementById('base-fee-input');
            if(baseFeeInput) baseFeeInput.value = base.monthlyFee || 10000;

            let intTr = document.createElement('tr'); intTr.className = "bg-emerald-50/50 text-[11px]";
            let intHtml = `<td class="p-3 font-black sticky left-0 z-10 border-r-2 border-emerald-200 bg-emerald-50 text-center whitespace-nowrap w-px text-black text-xs">월별 이자(+)</td>`;
            for(let i=0; i<12; i++) { intHtml += `<td class="p-1 border-r border-emerald-100 text-center"><input id="interest-${i}" type="number" value="${base.monthlyInterest[i] || 0}" ondblclick="this.select()" class="w-full text-center bg-transparent outline-none font-bold text-black" ${!isAdmin?'disabled':''} onchange="window.updateInterest(${i}, this.value)"></td>`; }
            intHtml += `<td class="bg-emerald-50/20 min-w-[150px] border-l border-emerald-100"></td>`;
            intTr.innerHTML = intHtml; mBody.appendChild(intTr);

            (appData.members || []).forEach(m => {
                const paid = (m.paidByYear?.[currentYear]) || Array(12).fill(false);
                const tr = document.createElement('tr'); const rowColor = memberColorMap[m.name] || 'bg-white';
                const isInactive = m.isInactive === true;
                const inactiveClass = isInactive ? "line-through grayscale opacity-40 pointer-events-none select-none" : "";
                tr.className = `${rowColor} border-b border-slate-100 text-xs hover:brightness-95 transition-all ${isInactive ? 'bg-slate-200' : ''}`;
                const infoItems = [];
                if(m.phone) infoItems.push({ val: m.phone, color: 'bg-white/60' });
                if(m.details) m.details.forEach((d, idx) => { infoItems.push({ val: d, color: (idx + 1) % 2 === 0 ? 'bg-white/60' : 'bg-black/5' }); });
                let extraInfoHtml = infoItems.map(item => `<div onclick="${isAdmin && !isInactive ? `window.editMemberDetail(${m.id})` : ''}" class="${item.color} px-2 py-0.5 rounded text-[10px] font-bold text-black truncate shadow-sm w-fit max-w-full ${isAdmin && !isInactive ? 'cursor-pointer hover:bg-emerald-200' : ''}">${item.val}</div>`).join('');
                
                let html = `
                    <td class="p-2 sticky left-0 z-10 border-r-2 border-slate-200 bg-inherit min-w-[250px] whitespace-nowrap w-px ${inactiveClass}">
                        <div class="flex items-start justify-between gap-2 px-1">
                            <div class="text-left flex-1 overflow-hidden">
                                <div class="flex items-center gap-1.5 mb-1.5">
                                    <div class="font-black text-black text-[16px] leading-tight w-fit ${isAdmin && !isInactive ? 'cursor-pointer hover:text-emerald-700' : ''}" 
                                         onclick="${isAdmin && !isInactive ? `window.toggleMemberRow(${m.id})` : ''}">${m.name}</div>
                                    ${isAdmin ? `
                                        <button onclick="window.removeMember(${m.id})" class="${isInactive ? 'text-blue-500' : 'text-gray-300 hover:text-red-500'} transition-all active:scale-90 ml-1" title="${isInactive ? '활성화' : '비활성화'}">
                                            <i class="fa-solid ${isInactive ? 'fa-rotate-left' : 'fa-trash-can'} text-[11px]"></i>
                                        </button>
                                    ` : ''}
                                </div>
                                <div class="grid grid-cols-2 gap-1.5">${extraInfoHtml}</div>
                            </div>
                            ${isAdmin && !isInactive ? `<button onclick="window.addMemberField(${m.id})" class="text-emerald-600 hover:scale-125 transition-transform flex-shrink-0 mt-1"><i class="fa-solid fa-circle-plus text-xl"></i></button>` : ''}
                        </div>
                    </td>`;
                paid.forEach((p, i) => { html += `<td class="p-1 border-r border-slate-100 ${inactiveClass}"><div onclick="${isAdmin && !isInactive ? `window.toggleMemberPaid(${m.id}, ${i})` : ''}" class="w-8 h-8 mx-auto flex items-center justify-center rounded-lg transition-all ${isAdmin && !isInactive ?'cursor-pointer':''} ${p ? 'bg-emerald-600 text-white shadow-md' : 'bg-white/50 border border-slate-200 hover:border-emerald-400'}"><i class="fa-solid fa-check text-xs"></i></div></td>`; });
                const memo = (m.memoByYear && m.memoByYear[currentYear]) || '';
                html += `<td class="p-1 border-r border-slate-100 min-w-[150px] ${inactiveClass}"><input id="memo-${m.id}" type="text" value="${memo}" ondblclick="this.select()" class="w-full h-8 text-[11px] bg-transparent outline-none border-b border-transparent focus:border-emerald-300 px-2 font-medium text-black" placeholder="메모 입력" ${!isAdmin || isInactive ?'disabled':''} onchange="window.updateMemberMemo(${m.id}, this.value)"></td>`;
                tr.innerHTML = html; mBody.appendChild(tr);
            });
            const years = [...(appData.years || [])].sort((a,b) => a-b);
            sHead.innerHTML = `<tr><th class="p-4 sticky left-0 z-20 bg-gray-100 border-r-2 border-slate-300 font-black text-center text-slate-700 whitespace-nowrap w-px">성명</th>` + years.map(y => `<th class="p-3 border-r border-slate-200 text-[11px] font-black text-center text-slate-500 min-w-[80px]">${y}년</th>`).join('') + `<th class="p-4 bg-emerald-100 text-emerald-900 border-l-2 border-emerald-200 font-black text-center whitespace-nowrap w-px">누적 횟수</th><th class="p-4 bg-emerald-700 text-white font-black text-center whitespace-nowrap w-px">누적 합계</th></tr>`;
            sBody.innerHTML = '';
            (appData.members || []).forEach(m => {
                let totalAmt = 0; let totalCount = 0;
                let trHtml = `<td class="p-4 sticky left-0 z-10 font-bold border-r-2 border-slate-300 bg-white text-center text-black whitespace-nowrap w-px ${m.isInactive?'line-through opacity-50':''}">${m.name}</td>`;
                years.forEach(y => {
                    const fee = (appData.financeBase[y]?.monthlyFee || 10000); const cnt = (m.paidByYear?.[y] || []).filter(p => p).length;
                    const amt = cnt * fee; totalCount += cnt; totalAmt += amt;
                    trHtml += `<td class="p-3 border-r border-slate-200 text-center"><span class="text-[12px] font-bold text-black">${cnt}회</span><br><span class="text-[10px] text-slate-400 font-mono">${amt.toLocaleString()}</span></td>`;
                });
                trHtml += `<td class="p-4 bg-emerald-50 font-black text-emerald-900 text-center text-sm border-l-2 border-emerald-100 whitespace-nowrap w-px">${totalCount}회</td><td class="p-4 bg-emerald-50 font-black text-emerald-900 text-center text-sm whitespace-nowrap w-px">${totalAmt.toLocaleString()}원</td>`;
                const tr = document.createElement('tr'); tr.className = "border-b border-slate-100 hover:bg-slate-50 transition-colors"; tr.innerHTML = trHtml; sBody.appendChild(tr);
            });
        }

        // --- 제어 및 이벤트 로직 ---
        window.updateMonthlyFee = (val) => { if(!isAdmin) return; if(!appData.financeBase[currentYear]) appData.financeBase[currentYear] = { carry: 0, monthlyFee: 10000, monthlyInterest: Array(12).fill(0) }; appData.financeBase[currentYear].monthlyFee = Number(val) || 0; window.saveToCloud(); };
        window.updateCarryOver = (val) => { if(!isAdmin) return; if(!appData.financeBase[currentYear]) appData.financeBase[currentYear] = { carry: 0, monthlyFee: 10000, monthlyInterest: Array(12).fill(0) }; appData.financeBase[currentYear].carry = Number(val) || 0; window.saveToCloud(); };
        window.formatPhone = (val) => { val = val.replace(/[^0-9]/g, ''); if (val.length < 4) return val; if (val.length < 7) return val.replace(/(\d{3})(\d{1,})/, '$1-$2'); if (val.length < 11) return val.replace(/(\d{3})(\d{3})(\d{1,})/, '$1-$2-$3'); return val.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3'); };
        window.addMember = () => { if(!isAdmin) return; const nI = document.getElementById('new-mem-name'); const pI = document.getElementById('new-mem-phone'); const name = nI.value.trim(); const phone = window.formatPhone(pI.value.trim()); if(!name) return; appData.members.push({ id: Date.now(), name, phone, details: [], memoByYear: {}, paidByYear: {}, isInactive: false }); nI.value = ''; pI.value = ''; window.saveToCloud(); window.showMessage(`${name}님이 등록되었습니다.`); setTimeout(() => nI.focus(), 50); };
        window.toggleMonthColumn = (mIdx) => { if(!isAdmin) return; const anyUnpaid = appData.members.filter(m => !m.isInactive).some(m => !((m.paidByYear?.[currentYear] || [])[mIdx])); appData.members.forEach(m => { if(m.isInactive) return; if(!m.paidByYear) m.paidByYear = {}; if(!m.paidByYear[currentYear]) m.paidByYear[currentYear] = Array(12).fill(false); m.paidByYear[currentYear][mIdx] = anyUnpaid; }); window.saveToCloud(); };
        window.toggleMemberRow = (id) => { if(!isAdmin) return; const m = appData.members.find(x => x.id === id); if(m.isInactive) return; const anyUnpaid = (m.paidByYear?.[currentYear] || Array(12).fill(false)).some(p => !p); m.paidByYear[currentYear] = Array(12).fill(anyUnpaid); window.saveToCloud(); };
        window.updateMemberMemo = (id, val) => { if(!isAdmin) return; const m = appData.members.find(x => x.id === id); if(!m.memoByYear) m.memoByYear = {}; m.memoByYear[currentYear] = val; window.saveToCloud(); };
        window.addMemberField = (id) => { if(!isAdmin) return; const m = appData.members.find(x => x.id === id); if(m.isInactive) return; const bodyHtml = `<input id="new-detail-input" ondblclick="this.select()" class="w-full p-4 border rounded-2xl font-bold bg-slate-50 text-black outline-none" placeholder="예: 부산, 고문 등" onkeydown="if(event.key==='Enter') { event.preventDefault(); document.getElementById('modal-confirm-btn').click(); }">`; window.openModal("정보 추가", bodyHtml, () => { const val = document.getElementById('new-detail-input').value.trim(); if(val) { if(!m.details) m.details = []; m.details.push(val); window.saveToCloud(); } return true; }); setTimeout(() => document.getElementById('new-detail-input')?.focus(), 100); };
        window.formatDateInput = (el) => { let v = el.value.replace(/[^0-9]/g, '').substring(0,6); if (v.length >= 6) v = v.substring(0,2) + '.' + v.substring(2,4) + '.' + v.substring(4,6); else if (v.length >= 4) v = v.substring(0,2) + '.' + v.substring(2,4) + (v.length > 4 ? '.' + v.substring(4) : ''); else if (v.length >= 2) v = v.substring(0,2) + (v.length > 2 ? '.' + v.substring(2) : ''); el.value = v; };
        window.updateLedgerItem = (idx, field, val) => { if(!isAdmin) return; if(!appData.ledger[currentYear]) return; appData.ledger[currentYear][idx][field] = val; window.saveToCloud(); };
        window.updateLedgerAmount = (idx, type, val) => { if(!isAdmin) return; if(!appData.ledger[currentYear]) return; appData.ledger[currentYear][idx].type = type; appData.ledger[currentYear][idx].amount = Number(val) || 0; window.saveToCloud(); };
        window.handleImageUpload = (e, idx) => { if(!isAdmin) return; const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (ev) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); const MAX_WIDTH = 800; let w = img.width, h = img.height; if(w > MAX_WIDTH) { h *= MAX_WIDTH / w; w = MAX_WIDTH; } canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h); appData.ledger[currentYear][idx].image = canvas.toDataURL('image/jpeg', 0.7); window.saveToCloud(); }; img.src = ev.target.result; }; reader.readAsDataURL(file); };
        window.handleLedgerEnter = (e, idx) => { if (e.key !== 'Enter') return; e.preventDefault(); const list = appData.ledger[currentYear]; const item = list[idx]; if (item.date && item.date.length === 8) { const ty = '20' + item.date.split('.')[0]; if (ty !== currentYear) { window.ensureYearExists(ty); if (!appData.ledger[ty]) appData.ledger[ty] = []; appData.ledger[ty].push({...item}); list.splice(idx, 1); currentYear = ty; } } Object.keys(appData.ledger).forEach(yr => { appData.ledger[yr].sort((a, b) => (a.date || "").localeCompare(b.date || "")); }); window.saveToCloud(); };
        window.addLedgerRow = () => { if(!isAdmin) return; if(!appData.ledger[currentYear]) appData.ledger[currentYear] = []; const filter = components.eventFilter().value || 'all'; const nextIdx = appData.ledger[currentYear].length; appData.ledger[currentYear].push({ event: filter === 'all' ? "" : filter, date: "", desc: "", type: "expense", amount: 0, note: "", image: "" }); window.saveToCloud(); setTimeout(() => { const el = document.getElementById(`ledger-${nextIdx}-event`); if(el) el.focus(); }, 50); };
        window.deleteLedger = (idx) => { if(!isAdmin) return; window.openModal("삭제", "정말 삭제하시겠습니까?", () => { appData.ledger[currentYear].splice(idx, 1); window.saveToCloud(); return true; }); };
        window.updateInterest = (idx, val) => { if(!isAdmin) return; if(!appData.financeBase[currentYear]) appData.financeBase[currentYear] = { carry: 0, monthlyFee: 10000, monthlyInterest: Array(12).fill(0) }; appData.financeBase[currentYear].monthlyInterest[idx] = Number(val) || 0; window.saveToCloud(); };
        window.toggleMemberPaid = (mid, mIdx) => { if(!isAdmin) return; const m = appData.members.find(x => x.id === mid); if(m.isInactive) return; if(!m.paidByYear) m.paidByYear = {}; if(!m.paidByYear[currentYear]) m.paidByYear[currentYear] = Array(12).fill(false); m.paidByYear[currentYear][mIdx] = !m.paidByYear[currentYear][mIdx]; window.saveToCloud(); };
        window.removeMember = (id) => { if(!isAdmin) return; const m = appData.members.find(x => x.id === id); const action = m.isInactive ? "활성화" : "비활성화"; const msg = m.isInactive ? "회원을 다시 활성화하시겠습니까?" : "비활성화하시겠습니까? 기록은 보존되나 수정은 차단됩니다."; window.openModal(`회원 ${action}`, `<p class="text-sm">${msg}</p>`, () => { m.isInactive = !m.isInactive; window.saveToCloud(); window.showMessage(`회원이 ${action}되었습니다.`); return true; }); };
        window.switchView = (id) => { document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden')); document.getElementById(`view-${id}`)?.classList.remove('hidden'); document.querySelectorAll('nav button').forEach(b => b.classList.remove('active', 'text-emerald-700', 'border-emerald-700', 'bg-emerald-50')); document.getElementById(`tab-${id}`)?.classList.add('active', 'text-emerald-700', 'border-emerald-700', 'bg-emerald-50'); };
        window.changeYear = (val) => { currentYear = val; renderAll(); };
        window.applyFilter = () => { renderLedger(); };
        window.editMemberDetail = (id) => { if(!isAdmin) return; const m = appData.members.find(x => x.id === id); if(m.isInactive) return; const bodyHtml = `
            <div class="space-y-4">
                <div><label class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">성함</label><input id="edit-name" ondblclick="this.select()" class="w-full p-3 border rounded-2xl font-bold bg-slate-50 text-black focus:ring-2 ring-emerald-500 outline-none" value="${m.name}"></div>
                <div><label class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">전화번호</label><input id="edit-phone" ondblclick="this.select()" oninput="this.value = window.formatPhone(this.value)" class="w-full p-3 border rounded-2xl font-mono bg-slate-50 text-black focus:ring-2 ring-emerald-500 outline-none" value="${m.phone || ''}"></div>
                <div id="details-edit-container"><label class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">추가 정보 리스트</label>${(m.details || []).map((d, idx) => `<div class="flex gap-2 mt-2 animate-in slide-in-from-left duration-200"><input class="flex-1 p-2 border rounded-xl text-sm bg-white text-black detail-item font-medium" ondblclick="this.select()" value="${d}"><button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-circle-xmark"></i></button></div>`).join('')}</div>
            </div>`;
            window.openModal("회원 정보 통합 수정", bodyHtml, () => { m.name = document.getElementById('edit-name').value.trim(); m.phone = document.getElementById('edit-phone').value.trim(); const detailInputs = document.querySelectorAll('.detail-item'); m.details = Array.from(detailInputs).map(i => i.value.trim()).filter(v => v); appData.members.sort((a, b) => a.name.localeCompare(b.name, 'ko')); window.saveToCloud(); return true; });
        };
        window.handleAuth = async () => { if (isAdmin) { window.openModal("로그아웃", "로그아웃 하시겠습니까?", async () => { await signOut(auth); window.location.reload(); return true; }); } else { const bodyHtml = `<div class="space-y-4"><input type="email" id="login-email" ondblclick="this.select()" class="w-full p-3 border rounded-xl text-black" placeholder="이메일"><input type="password" id="login-pw" ondblclick="this.select()" class="w-full p-3 border rounded-xl text-black" placeholder="비밀번호"></div>`; window.openModal("관리자 로그인", bodyHtml, async () => { const email = document.getElementById('login-email').value; const pw = document.getElementById('login-pw').value; try { await signInWithEmailAndPassword(auth, email, pw); window.showMessage("관리자로 로그인되었습니다."); return true; } catch (e) { window.showMessage("로그인 실패"); return false; } }); } };
        
        // 초기 인증 실행
        initAuth();
        window.onload = () => { switchView('ledger'); };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; color: #334155; }
        .tab-btn { border-bottom: 4px solid transparent; transition: all 0.2s; }
        .tab-btn.active { border-bottom-color: #059669; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        select { appearance: none; }
        input:focus { background-color: #f0fdf4 !important; border-bottom: 2px solid #10b981 !important; outline: none; }
        th { text-align: center !important; }
        .sticky-col { position: sticky; left: 0; z-index: 10; border-right: 2px solid #e2e8f0 !important; }
        th.sticky-col { z-index: 20; }
        .admin-only { display: none; }
        
        #carry-over-input { color: white !important; transition: all 0.2s; }
        #carry-over-input:focus { color: black !important; background-color: white !important; border-color: #10b981 !important; }
        
        main input, main select, main textarea, .modal input { color: #000000 !important; }
        input::placeholder { color: #94a3b8 !important; }
    </style>
</head>
<body class="min-h-screen">
    <div id="datalist-container"></div>
    <input type="file" id="excel-upload" class="hidden" accept=".xlsx, .xls" onchange="window.handleExcelUpload(event)">
    <div id="toast-message" class="fixed top-5 left-1/2 -translate-x-1/2 z-[100] bg-slate-800 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl opacity-0"></div>

    <div id="image-viewer" class="fixed inset-0 bg-black/90 z-[110] hidden items-center justify-center p-4 cursor-pointer" onclick="window.closeImageViewer()">
        <img id="viewer-img" src="" class="max-w-full max-h-full rounded-lg shadow-2xl object-contain">
        <button class="absolute top-5 right-5 text-white text-3xl"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-black/60 z-[90] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl animate-in fade-in zoom-in duration-300">
            <div class="p-6"><h3 id="modal-title" class="text-lg font-black text-slate-900 mb-4 text-center border-b pb-2">알림</h3><div id="modal-body" class="text-slate-600"></div></div>
            <div class="flex border-t"><button onclick="window.closeModal()" class="flex-1 py-4 text-sm font-bold text-slate-400 hover:bg-slate-50 transition-colors">취소</button><button id="modal-confirm-btn" class="flex-1 py-4 text-sm font-black text-emerald-600 hover:bg-emerald-50 border-l transition-colors">확인</button></div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto bg-white shadow-2xl min-h-screen flex flex-col border-x border-gray-200">
        <!-- 상단 바 -->
        <div class="bg-slate-900 text-white text-[11px] p-2.5 px-5 flex flex-wrap gap-y-2 justify-between items-center shadow-md">
            <div class="flex items-center flex-wrap gap-3">
                <div class="flex items-center bg-white rounded-full border border-white/5 pr-1 shadow-sm">
                    <div class="flex items-center gap-1.5 px-3 py-1.5"><i class="fa-solid fa-users text-emerald-600"></i><span class="font-black text-gray-400 uppercase tracking-tighter text-slate-400">모임</span><select id="meeting-select" onchange="window.onMeetingChange(event)" class="bg-transparent text-black font-black border-none outline-none cursor-pointer pr-4"></select></div>
                    <button onclick="window.addNewMeeting()" class="bg-emerald-600 hover:bg-emerald-500 w-7 h-7 rounded-full flex items-center justify-center admin-only shadow-lg"><i class="fa-solid fa-plus text-[10px]"></i></button>
                </div>
                <div class="flex items-center bg-white rounded-full border border-white/5 pr-1 shadow-sm">
                    <div class="flex items-center gap-1.5 px-3 py-1.5"><i class="fa-solid fa-calendar-days text-emerald-600"></i><span class="font-black text-gray-400 uppercase tracking-tighter text-slate-400">연도</span><select id="year-dropdown" onchange="window.changeYear(this.value)" class="bg-transparent text-black font-black border-none outline-none cursor-pointer pr-4"></select></div>
                    <button onclick="window.addNewYear()" class="bg-emerald-600 hover:bg-emerald-500 w-7 h-7 rounded-full flex items-center justify-center admin-only shadow-lg"><i class="fa-solid fa-plus text-[10px]"></i></button>
                </div>
                <button onclick="window.copyShareLink()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded-full flex items-center gap-2 shadow-md transition-all active:scale-95">
                    <i class="fa-solid fa-share-nodes text-[10px]"></i><span class="font-black text-[10px] uppercase tracking-widest">링크공유</span>
                </button>
            </div>
            <div class="flex gap-2">
                <button onclick="window.downloadTemplate()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded-lg font-black uppercase tracking-tighter shadow-md admin-only"><i class="fa-solid fa-file-excel mr-1"></i> 양식다운</button>
                <button onclick="window.triggerUpload()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded-lg font-black uppercase tracking-tighter shadow-md admin-only"><i class="fa-solid fa-file-import mr-1"></i> 데이터업로드</button>
                <button id="loginBtn" onclick="window.handleAuth()" class="bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 rounded-lg font-black uppercase tracking-tighter shadow-md">관리자 로그인</button>
            </div>
        </div>

        <header class="bg-gradient-to-br from-emerald-900 to-slate-900 text-white p-8 relative overflow-hidden">
            <div class="absolute -right-20 -top-20 w-64 h-64 bg-emerald-500/10 rounded-full blur-3xl"></div>
            <div class="flex justify-between items-end mb-8 relative z-10">
                <div>
                    <h1 id="main-title" onclick="window.renameMeeting()" class="text-3xl font-black tracking-tighter cursor-pointer hover:text-emerald-400 transition-colors group">황제모임 가계부 <i class="fa-solid fa-pen text-xs ml-2 opacity-0 group-hover:opacity-50 admin-only inline-block"></i></h1>
                    <span id="title-year" class="text-emerald-500 font-medium text-lg"></span>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4 relative z-10 mb-4 text-center">
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10 backdrop-blur-md transition-all">
                    <p class="text-[10px] text-emerald-400 font-black uppercase mb-1 tracking-widest opacity-80">이월액</p>
                    <input type="number" id="carry-over-input" ondblclick="this.select()" onchange="window.updateCarryOver(this.value)" class="bg-transparent text-lg font-black w-full outline-none text-center rounded-lg transition-all" placeholder="0">
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10 backdrop-blur-md"><p class="text-[10px] text-emerald-400 font-black uppercase mb-1 tracking-widest opacity-80">회비 합계</p><h3 id="fee-total-display" class="text-lg font-black text-white">0원</h3></div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10 backdrop-blur-md"><p class="text-[10px] text-emerald-400 font-black uppercase mb-1 tracking-widest opacity-80">이자 합계</p><h3 id="interest-total-display" class="text-lg font-black text-white">0원</h3></div>
            </div>
            <div class="bg-emerald-500 p-5 rounded-2xl shadow-2xl border border-emerald-400/30 relative z-10"><div class="flex justify-between items-center"><p class="text-[11px] text-emerald-900 font-black uppercase tracking-widest italic">현재 총 잔액</p><h3 id="final-balance" class="text-3xl font-black text-white tracking-tighter">0원</h3></div></div>
        </header>

        <nav class="flex items-center border-b sticky top-0 bg-white/90 backdrop-blur-lg z-20 shadow-sm">
            <button id="tab-ledger" onclick="window.switchView('ledger')" class="tab-btn flex-1 py-5 text-sm font-black text-slate-400 active">장부 기록</button>
            <div class="h-6 w-px bg-slate-200"></div>
            <button id="tab-member" onclick="window.switchView('member')" class="tab-btn flex-1 py-5 text-sm font-black text-slate-400">명부 및 정산</button>
        </nav>

        <main class="p-6 flex-1 bg-slate-50/30">
            <!-- 가계부 탭 -->
            <div id="view-ledger" class="space-y-4">
                <div class="flex flex-col sm:flex-row gap-4 items-center justify-between">
                    <div class="flex items-center bg-white rounded-full border border-slate-200 shadow-sm px-3 py-1.5">
                        <i class="fa-solid fa-filter text-emerald-500 text-xs mr-1.5"></i>
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter mr-2 text-slate-400">행사명</span>
                        <select id="event-filter" onchange="window.applyFilter()" class="bg-transparent text-xs font-bold text-black border-none outline-none min-w-[120px]"></select>
                    </div>
                    <div id="filter-summary" class="text-right"></div>
                </div>
                <div class="overflow-x-auto rounded-3xl border border-slate-200 bg-white shadow-xl">
                    <table class="w-full text-center border-collapse">
                        <thead class="bg-slate-50/50 text-slate-400 text-[10px] font-black uppercase tracking-widest border-b border-slate-200">
                            <tr><th class="p-4 sticky-col border-r-2 border-slate-200 bg-slate-50 min-w-[120px]">행사명</th><th class="p-4 min-w-[90px] border-r border-slate-200">날짜</th><th class="p-4 min-w-[200px] border-r border-slate-200">상세내역</th><th class="p-4 text-right min-w-[90px] border-r border-slate-200">입금</th><th class="p-4 text-right min-w-[90px] border-r border-slate-200">지출</th><th class="p-4 text-right bg-black/5 font-black border-r border-slate-200 min-w-[100px]">잔액</th><th class="p-4 min-w-[80px] border-r border-slate-200">영수증</th><th class="p-4 min-w-[150px] border-r border-slate-200 text-center">비고</th><th class="p-4 admin-only w-10 text-center"></th></tr>
                        </thead>
                        <tbody id="ledger-body"></tbody>
                    </table>
                </div>
                <button onclick="window.addLedgerRow()" class="w-full py-6 border-2 border-dashed border-slate-200 text-slate-400 font-black rounded-3xl hover:bg-white hover:border-emerald-300 transition-all admin-only group flex-only items-center justify-center">
                    <i class="fa-solid fa-circle-plus mr-2 text-lg group-hover:scale-110"></i>거래 내역 추가 (인라인 편집)
                </button>
            </div>
            
            <div id="view-member" class="hidden space-y-10">
                <!-- 통합 명부 섹션 -->
                <section class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-black text-slate-800 tracking-tight flex items-center gap-2"><i class="fa-solid fa-user-check text-emerald-600"></i> 회원 명부 및 월납 현황</h2>
                        <div class="admin-only flex gap-2 items-center">
                            <div class="flex items-center gap-1 bg-white border border-slate-200 rounded-xl px-2 shadow-sm">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter text-slate-400">회비</span>
                                <input type="number" id="base-fee-input" ondblclick="this.select()" class="w-20 p-2 text-sm font-bold outline-none text-black bg-transparent" onchange="window.updateMonthlyFee(this.value)">
                            </div>
                            <div class="h-6 w-px bg-slate-200 mx-1"></div>
                            <input type="text" id="new-mem-name" placeholder="이름" ondblclick="this.select()" class="w-24 p-2.5 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 ring-emerald-500 font-bold bg-white text-black shadow-sm">
                            <input type="text" id="new-mem-phone" placeholder="전화번호" ondblclick="this.select()" oninput="this.value = window.formatPhone(this.value)" onkeydown="if(event.key==='Enter') { event.preventDefault(); window.addMember(); }" class="w-32 p-2.5 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 ring-emerald-500 font-bold bg-white text-black shadow-sm">
                            <button onclick="window.addMember()" class="bg-slate-900 text-white px-6 rounded-xl text-sm font-black shadow-lg hover:bg-emerald-700 transition-colors">등록</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto rounded-3xl border border-slate-200 bg-white shadow-2xl">
                        <table class="w-full text-center border-collapse">
                            <thead class="bg-slate-100 text-[10px] text-slate-500 font-black uppercase tracking-widest border-b border-slate-200">
                                <tr>
                                    <th class="p-4 sticky left-0 z-20 bg-slate-100 border-r-2 border-slate-200 min-w-[250px] whitespace-nowrap w-px text-black">회원 정보</th>
                                    <th onclick="window.toggleMonthColumn(0)" class="p-2 border-r border-slate-200 font-black text-emerald-700 bg-emerald-50/30 cursor-pointer hover:bg-emerald-100">1</th>
                                    <th onclick="window.toggleMonthColumn(1)" class="p-2 border-r border-slate-200 font-black text-emerald-700 bg-emerald-50/30 cursor-pointer hover:bg-emerald-100">2</th>
                                    <th onclick="window.toggleMonthColumn(2)" class="p-2 border-r border-slate-200 font-black text-emerald-700 bg-emerald-50/30 cursor-pointer hover:bg-emerald-100">3</th>
                                    <th onclick="window.toggleMonthColumn(3)" class="p-2 border-r border-slate-200 font-black text-emerald-700 bg-emerald-50/30 cursor-pointer hover:bg-emerald-100">4</th>
                                    <th onclick="window.toggleMonthColumn(4)" class="p-2 border-r border-slate-200 font-black text-emerald-700 bg-emerald-50/30 cursor-pointer hover:bg-emerald-100">5</th>
                                    <th onclick="window.toggleMonthColumn(5)" class="p-2 border-r border-slate-200 font-black text-emerald-700 bg-emerald-50/30 cursor-pointer hover:bg-emerald-100">6</th>
                                    <th onclick="window.toggleMonthColumn(6)" class="p-2 border-r border-slate-200 font-black text-emerald-700 bg-emerald-50/30 cursor-pointer hover:bg-emerald-100">7</th>
                                    <th onclick="window.toggleMonthColumn(7)" class="p-2 border-r border-slate-200 font-black text-emerald-700 bg-emerald-50/30 cursor-pointer hover:bg-emerald-100">8</th>
                                    <th onclick="window.toggleMonthColumn(8)" class="p-2 border-r border-slate-200 font-black text-emerald-700 bg-emerald-50/30 cursor-pointer hover:bg-emerald-100">9</th>
                                    <th onclick="window.toggleMonthColumn(9)" class="p-2 border-r border-slate-200 font-black text-emerald-700 bg-emerald-50/30 cursor-pointer hover:bg-emerald-100">10</th>
                                    <th onclick="window.toggleMonthColumn(10)" class="p-2 border-r border-slate-200 font-black text-emerald-700 bg-emerald-50/30 cursor-pointer hover:bg-emerald-100">11</th>
                                    <th onclick="window.toggleMonthColumn(11)" class="p-2 border-r border-slate-200 font-black text-emerald-700 bg-emerald-50/30 cursor-pointer hover:bg-emerald-100">12</th>
                                    <th class="p-4 min-w-[150px] border-l border-emerald-100 whitespace-nowrap text-black">비고 (메모)</th>
                                </tr>
                            </thead>
                            <tbody id="member-body"></tbody>
                        </table>
                    </div>
                </section>
                <section class="space-y-4">
                    <h2 class="text-xl font-black text-slate-800 tracking-tight flex items-center gap-2"><i class="fa-solid fa-chart-line text-emerald-600"></i> 년도별 회비 정산 요약</h2>
                    <div class="overflow-x-auto rounded-3xl border border-slate-200 bg-white shadow-2xl">
                        <table class="w-full text-center border-collapse">
                            <thead id="settle-header-row" class="bg-slate-100 font-black text-slate-500 uppercase tracking-widest border-b-2 border-slate-200 text-black"></thead>
                            <tbody id="settle-body"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
        <footer class="p-8 text-center text-[10px] text-slate-400 border-t bg-slate-50 font-bold tracking-[0.2em] uppercase">&copy; 2026 <span id="footer-meeting-name"></span> 재정 관리 시스템.</footer>
    </div>
</body>
</html>